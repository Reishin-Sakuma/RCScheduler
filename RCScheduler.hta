<!DOCTYPE html>
<html lang="ja">
<head>
<HTA:APPLICATION
    ID="RCScheduler"
    APPLICATIONNAME="RCScheduler"
    BORDER="thick"
    BORDERSTYLE="normal"
    CAPTION="yes"
    ICON=""
    MAXIMIZEBUTTON="yes"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    SCROLL="yes"
    WINDOWSTATE="normal"
/>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>RCScheduler - ver.2.1.0</title>

<style>
    /* ====================================== */
    /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒCSS                         */
    /* ====================================== */

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        --primary: #3b82f6;
        --secondary: #6b7280;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-tertiary: #404040;
        --white: #ffffff;
        --dark: #0f0f0f;
        --border: #404040;
        --text: #e5e5e5;
        --text-muted: #a1a1a1;
        --text-dark: #ffffff;
    }

    body {
        font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
        background-color: #1a1a1a;
        color: #e5e5e5;
        padding: 20px;
        overflow-y: scroll;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        margin-bottom: 25px;
    }

    .header h1 {
        font-size: 28px;
        font-weight: bold;
        color: #ffffff;
        display: inline-block;
    }

    .header .version {
        font-size: 16px;
        color: #a1a1a1;
        margin-left: 10px;
    }

    .header .description {
        font-size: 14px;
        color: #a1a1a1;
        margin-top: 10px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .section {
        background-color: #2d2d2d;
        border: 1px solid #404040;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 16px;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #404040;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ— */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        color: #e5e5e5;
        margin-bottom: 5px;
    }

    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="number"],
    .form-group select {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
        background-color: #404040;
        color: #e5e5e5;
        border: 1px solid #404040;
        border-radius: 4px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ¨ªä¸¦ã³ï¼‰ */
    .form-inline {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .form-inline .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .form-inline button {
        flex-shrink: 0;
    }

    /* ãƒœã‚¿ãƒ³ */
    button {
        padding: 10px 20px;
        font-size: 15px;
        font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
        font-weight: bold;
        color: #ffffff;
        background-color: #3b82f6;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #1d4ed8;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover:not(:disabled) {
        background-color: #475569;
    }

    .btn-success {
        background-color: #10b981;
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        background-color: #059669;
    }

    .btn-warning {
        background-color: #f59e0b;
        color: white;
    }

    .btn-warning:hover:not(:disabled) {
        background-color: #d97706;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-danger:hover:not(:disabled) {
        background-color: #dc2626;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ»ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ */
    .checkbox-group,
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .checkbox-group label,
    .radio-group label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .checkbox-group input,
    .radio-group input {
        margin-right: 8px;
    }

    /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .grid {
        display: grid;
        gap: 15px;
    }

    .grid-2 {
        grid-template-columns: 1fr 1fr;
    }

    .grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
    }

    /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
    .log-area {
        width: 100%;
        height: 200px;
        padding: 10px;
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 12px;
        background-color: #0f0f0f;
        color: #e5e5e5;
        border: 1px solid #404040;
        border-radius: 4px;
        overflow-y: scroll;
        resize: vertical;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
    .status-bar {
        background-color: #404040;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .status-bar .status-label {
        font-weight: bold;
        color: #ffffff;
    }

    .status-bar .status-value {
        color: #a1a1a1;
    }

    /* ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ */
    .separator {
        height: 1px;
        background-color: #404040;
        margin: 20px 0;
    }

    /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
    .task-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.2s;
    }

    .task-card:hover {
        border-color: var(--primary);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
    }

    .task-card.disabled {
        opacity: 0.5;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .task-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .task-title input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .task-title h3 {
        font-size: 18px;
        color: var(--white);
        margin: 0;
    }

    .task-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
    }

    .task-status.active {
        background-color: var(--success);
        color: var(--white);
    }

    .task-status.inactive {
        background-color: var(--secondary);
        color: var(--white);
    }

    .task-info {
        margin-bottom: 15px;
    }

    .task-path {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .task-path-item {
        font-size: 14px;
        color: var(--text);
        background-color: var(--bg-tertiary);
        padding: 6px 12px;
        border-radius: 4px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .task-arrow {
        color: var(--primary);
        font-size: 16px;
        font-weight: bold;
    }

    .task-schedule {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-muted);
    }

    .task-schedule-icon {
        color: var(--primary);
    }

    .task-actions {
        display: flex;
        gap: 8px;
    }

    /* å°ã•ã„ãƒ†ã‚­ã‚¹ãƒˆ */
    .text-small {
        font-size: 12px;
        color: #a1a1a1;
    }

    /* é€±é¸æŠã‚°ãƒªãƒƒãƒ‰ */
    .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
    }

    .week-grid label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
        background-color: #404040;
        border: 1px solid #404040;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .week-grid label:hover {
        background-color: #1a1a1a;
    }

    .week-grid input[type="checkbox"] {
        margin-bottom: 5px;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .action-buttons button {
        flex: 1;
        min-width: 150px;
    }

    /* èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
    .auth-section {
        margin-top: 10px;
        padding: 10px;
        background-color: #404040;
        border-radius: 4px;
        border: 1px solid #404040;
    }

    .auth-section.disabled {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
</head>
<body>

<div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <h1>RCScheduler</h1>
        <span class="version">v2.1.0</span>
        <p class="description">
            Robocopyã‚’ä½¿ã£ãŸè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã€‚è¤‡æ•°ã‚¿ã‚¹ã‚¯ã®ç®¡ç†ã€ãƒ•ã‚©ãƒ«ãƒ€ã®åŒæœŸã€ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
        </p>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                ğŸ“‹ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
                <span id="taskCount" style="color: var(--text-muted); font-size: 14px; margin-left: 10px;">(0ä»¶)</span>
            </div>
            <button class="btn btn-primary" onclick="showAddTaskDialog()" style="padding: 8px 16px;">
                â• æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ 
            </button>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="taskListArea">
            <!-- ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ç©ºã®çŠ¶æ…‹ -->
        <div id="emptyTaskState" style="display: none; text-align: center; padding: 60px 20px; border: 2px dashed var(--border); border-radius: 6px; margin-top: 15px;">
            <div style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;">ğŸ“‹</div>
            <h3 style="color: var(--white); margin-bottom: 10px;">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">ã€Œæ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æœ€åˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚</p>
        </div>
    </div>

    <!-- Robocopyè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ»ç·¨é›†æ™‚ã«ä½¿ç”¨ï¼‰ -->
    <div id="taskEditorSection" style="display: none;">
    <div class="section">
        <div class="section-title">ğŸ“ Robocopyè¨­å®š</div>

        <!-- ã‚³ãƒ”ãƒ¼å…ƒ -->
        <div class="form-inline">
            <div class="form-group">
                <label for="source">ã‚³ãƒ”ãƒ¼å…ƒãƒ•ã‚©ãƒ«ãƒ€</label>
                <input type="text" id="source" placeholder="ä¾‹: C:\Source ã¾ãŸã¯ \\server\share">
            </div>
            <button class="btn-secondary btn-small" onclick="browseFolder('source')">å‚ç…§...</button>
        </div>

        <!-- ã‚³ãƒ”ãƒ¼å…ƒèªè¨¼ -->
        <div id="sourceAuthSection" class="auth-section disabled">
            <p class="text-small" style="margin-bottom: 10px;">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚¹èªè¨¼æƒ…å ±</p>
            <div class="grid grid-3">
                <div class="form-group">
                    <label for="sourceUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="sourceUsername">
                </div>
                <div class="form-group">
                    <label for="sourcePassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="sourcePassword">
                </div>
                <div class="form-group">
                    <label for="sourceDomain">ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="sourceDomain">
                </div>
            </div>
            <button class="btn-primary btn-small" onclick="testNetworkConnection('source')">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>

        <!-- ã‚³ãƒ”ãƒ¼å…ˆ -->
        <div class="form-inline" style="margin-top: 15px;">
            <div class="form-group">
                <label for="dest">ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€</label>
                <input type="text" id="dest" placeholder="ä¾‹: D:\Backup ã¾ãŸã¯ \\backup-server\share">
            </div>
            <button class="btn-secondary btn-small" onclick="browseFolder('dest')">å‚ç…§...</button>
        </div>

        <!-- ã‚³ãƒ”ãƒ¼å…ˆèªè¨¼ -->
        <div id="destAuthSection" class="auth-section disabled">
            <p class="text-small" style="margin-bottom: 10px;">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚¹èªè¨¼æƒ…å ±</p>
            <div class="grid grid-3">
                <div class="form-group">
                    <label for="destUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="destUsername">
                </div>
                <div class="form-group">
                    <label for="destPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="destPassword">
                </div>
                <div class="form-group">
                    <label for="destDomain">ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="destDomain">
                </div>
            </div>
            <button class="btn-primary btn-small" onclick="testNetworkConnection('dest')">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div class="separator"></div>

        <!-- ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰ -->
        <div class="form-group">
            <label>ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="copyMode" value="MIR" checked>
                    /MIRï¼ˆãƒŸãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰ - ã‚³ãƒ”ãƒ¼å…ˆã‚’å®Œå…¨åŒæœŸã€å‰Šé™¤ã‚‚åæ˜ ï¼‰
                </label>
                <label>
                    <input type="radio" name="copyMode" value="E">
                    /Eï¼ˆã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼ - å‰Šé™¤ã¯åŒæœŸã—ãªã„ï¼‰
                </label>
            </div>
        </div>

        <!-- Robocopyã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div class="form-group">
            <label>Robocopyã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="optNoProgress" checked>
                    /NPï¼ˆé€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤ºã—ãªã„ï¼‰
                </label>
                <label>
                    <input type="checkbox" id="optNoDirList" checked>
                    /NDLï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ãªã„ï¼‰
                </label>
                <label>
                    <input type="checkbox" id="optSec">
                    /SECï¼ˆNTFSæ¨©é™ã‚‚ã‚³ãƒ”ãƒ¼ï¼‰
                </label>
                <label>
                    <input type="checkbox" id="optListOnly">
                    /Lï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - å®Ÿéš›ã«ã¯ã‚³ãƒ”ãƒ¼ã—ãªã„ï¼‰
                </label>
                <label>
                    <input type="checkbox" id="optEnableLog" checked>
                    LOGï¼ˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²ï¼‰
                </label>
            </div>
        </div>

        <!-- ãƒªãƒˆãƒ©ã‚¤è¨­å®š -->
        <div class="grid grid-2">
            <div class="form-group">
                <label for="retryCount">ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆ/Rï¼‰</label>
                <input type="number" id="retryCount" value="3" min="0" max="100">
            </div>
            <div class="form-group">
                <label for="waitTime">å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰ï¼ˆ/Wï¼‰</label>
                <input type="number" id="waitTime" value="10" min="0" max="3600">
            </div>
        </div>

        <!-- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ« -->
        <div class="form-inline">
            <div class="form-group">
                <label for="logFile">ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹</label>
                <input type="text" id="logFile" placeholder="ä¾‹: C:\Logs\robocopy.log">
            </div>
            <button class="btn-secondary btn-small" onclick="browseFile('logFile')">å‚ç…§...</button>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div class="form-group">
            <label for="customOptions">ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¿½åŠ ã®Robocopyã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <input type="text" id="customOptions" placeholder="ä¾‹: /MAXAGE:7 /XO">
        </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <div class="section-title">â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</div>

        <!-- ã‚¿ã‚¹ã‚¯å -->
        <div class="form-group">
            <label for="taskName">ã‚¿ã‚¹ã‚¯å</label>
            <input type="text" id="taskName" value="RobocopyBackupTask" placeholder="ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ç™»éŒ²ã•ã‚Œã‚‹åå‰">
        </div>

        <!-- å®Ÿè¡Œé »åº¦ -->
        <div class="form-group">
            <label>å®Ÿè¡Œé »åº¦</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="frequency" value="DAILY" checked onchange="updateWeekdayState()">
                    æ¯æ—¥å®Ÿè¡Œ
                </label>
                <label>
                    <input type="radio" name="frequency" value="WEEKLY" onchange="updateWeekdayState()">
                    æ¯é€±å®Ÿè¡Œ
                </label>
            </div>
        </div>

        <!-- æ›œæ—¥é¸æŠ -->
        <div id="weekdaySection" style="display: none;">
            <label>å®Ÿè¡Œæ›œæ—¥</label>
            <div class="week-grid">
                <label>
                    <input type="checkbox" value="MON">
                    <span>æœˆ</span>
                </label>
                <label>
                    <input type="checkbox" value="TUE">
                    <span>ç«</span>
                </label>
                <label>
                    <input type="checkbox" value="WED">
                    <span>æ°´</span>
                </label>
                <label>
                    <input type="checkbox" value="THU">
                    <span>æœ¨</span>
                </label>
                <label>
                    <input type="checkbox" value="FRI">
                    <span>é‡‘</span>
                </label>
                <label>
                    <input type="checkbox" value="SAT">
                    <span>åœŸ</span>
                </label>
                <label>
                    <input type="checkbox" value="SUN">
                    <span>æ—¥</span>
                </label>
            </div>
        </div>

        <!-- å®Ÿè¡Œæ™‚åˆ» -->
        <div class="grid grid-2">
            <div class="form-group">
                <label for="hour">å®Ÿè¡Œæ™‚åˆ» - æ™‚</label>
                <input type="number" id="hour" value="2" min="0" max="23">
            </div>
            <div class="form-group">
                <label for="minute">å®Ÿè¡Œæ™‚åˆ» - åˆ†</label>
                <input type="number" id="minute" value="0" min="0" max="59">
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯å±¥æ­´ -->
        <div class="form-group">
            <label>
                <input type="checkbox" id="historyEnabled" checked>
                ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹
            </label>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <div class="section-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®š</div>

        <!-- ãƒ¡ãƒ¼ãƒ«æœ‰åŠ¹åŒ– -->
        <div class="form-group">
            <label>
                <input type="checkbox" id="emailEnabled" onchange="toggleEmailSettings()">
                ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            </label>
        </div>

        <div id="emailSettings" style="display: none;">
            <!-- SMTPè¨­å®š -->
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="smtpServer">SMTPã‚µãƒ¼ãƒãƒ¼</label>
                    <input type="text" id="smtpServer" placeholder="ä¾‹: smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label for="smtpPort">ãƒãƒ¼ãƒˆ</label>
                    <input type="number" id="smtpPort" value="587" min="1" max="65535">
                </div>
            </div>

            <!-- æ¥ç¶šä¿è­· -->
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="connectionSecurity">æ¥ç¶šã®ä¿è­·</label>
                    <select id="connectionSecurity">
                        <option value="æš—å·åŒ–ãªã—">æš—å·åŒ–ãªã—</option>
                        <option value="STARTTLS" selected>STARTTLS</option>
                        <option value="SSL/TLS">SSL/TLS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="authMethod">èªè¨¼æ–¹å¼</label>
                    <select id="authMethod">
                        <option value="BASIC" selected>BASIC</option>
                        <option value="CRAM-MD5">CRAM-MD5</option>
                    </select>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼æƒ…å ± -->
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="senderEmail">é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="text" id="senderEmail" placeholder="ä¾‹: sender@example.com">
                </div>
                <div class="form-group">
                    <label for="senderPassword">é€ä¿¡è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="senderPassword">
                </div>
            </div>

            <!-- å—ä¿¡è€… -->
            <div class="form-group">
                <label for="recipientEmail">å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="text" id="recipientEmail" placeholder="ä¾‹: recipient@example.com">
            </div>

            <!-- SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆ -->
            <div class="action-buttons">
                <button class="btn-primary btn-small" onclick="testSmtpConnection()">SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                <button class="btn-success btn-small" onclick="sendTestMail()">ãƒ¡ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆé€ä¿¡</button>
            </div>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="section">
        <div class="section-title">ğŸ“Š ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="status-bar">
            <span class="status-label">ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹: </span>
            <span class="status-value" id="taskStatus">ç¢ºèªä¸­...</span>
        </div>
        <button class="btn-secondary btn-small" onclick="updateTaskStatus()">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</button>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="section">
        <div class="action-buttons" style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-primary" onclick="saveCurrentTask()" style="padding: 12px 30px; font-size: 16px;">ğŸ’¾ ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜</button>
            <button class="btn-secondary" onclick="cancelTaskEdit()" style="padding: 12px 30px; font-size: 16px;">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    </div>

    <!-- ãƒ­ã‚°è¡¨ç¤º -->
    <div class="section">
        <div class="section-title">ğŸ“ ãƒ­ã‚°</div>
        <textarea class="log-area" id="logArea" readonly></textarea>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯å±¥æ­´è¨­å®š -->
    <div class="section">
        <div class="section-title">ğŸ“‹ ã‚¿ã‚¹ã‚¯å±¥æ­´è¨­å®š</div>
        <p class="text-small" style="margin-bottom: 15px;">
            Windowsã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°æ©Ÿèƒ½ã‚’ç®¡ç†ã—ã¾ã™ã€‚<br>
            â€»ã“ã®æ“ä½œã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
        </p>
        <div class="status-bar">
            <span class="status-label">ç¾åœ¨ã®å±¥æ­´è¨­å®š: </span>
            <span class="status-value" id="taskHistoryStatus">ç¢ºèªä¸­...</span>
        </div>
        <div class="action-buttons" style="margin-top: 15px;">
            <button class="btn-success" onclick="enableTaskHistory()">å±¥æ­´ã‚’æœ‰åŠ¹åŒ–</button>
            <button class="btn-warning" onclick="disableTaskHistory()">å±¥æ­´ã‚’ç„¡åŠ¹åŒ–</button>
            <button class="btn-secondary" onclick="getTaskHistoryStatus()">ç¾åœ¨ã®è¨­å®šç¢ºèª</button>
        </div>
    </div>
</div>

<script type="text/javascript">
// ======================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ======================================

var VERSION = "2.1.0";
var CONFIG_FILE = "robocopy_config.json";  // æ—§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
var TASKS_FOLDER = "RCScheduler_tasks";    // ã‚¿ã‚¹ã‚¯è¨­å®šãƒ•ã‚©ãƒ«ãƒ€
var fso = new ActiveXObject("Scripting.FileSystemObject");
var shell = new ActiveXObject("WScript.Shell");
var shellApp = new ActiveXObject("Shell.Application");

// ã‚¿ã‚¹ã‚¯ç®¡ç†ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var tasks = [];  // å…¨ã‚¿ã‚¹ã‚¯ã®é…åˆ—

// ======================================
// åˆæœŸåŒ–
// ======================================

window.onload = function() {
    logMessage("RCSchedulerãŒèµ·å‹•ã—ã¾ã—ãŸ - ver." + VERSION);

    // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (!isAdmin()) {
        logMessage("ç®¡ç†è€…æ¨©é™ãªã—ã§èµ·å‹•ã—ã¦ã„ã¾ã™ - ç®¡ç†è€…æ¨©é™ã§å†èµ·å‹•ã—ã¾ã™", "warning");

        if (confirm("ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚\n\n" +
                    "ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ã‚„SYSTEMæ¨©é™ã§ã®å®Ÿè¡Œã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…é ˆã§ã™ã€‚\n\n" +
                    "ç®¡ç†è€…æ¨©é™ã§å†èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
            runAsAdmin();
            return; // å†èµ·å‹•ã™ã‚‹ã®ã§ã“ã“ã§å‡¦ç†çµ‚äº†
        } else {
            alert("ç®¡ç†è€…æ¨©é™ãªã—ã§ç¶šè¡Œã—ã¾ã™ã€‚ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚");
            logMessage("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…æ¨©é™æ˜‡æ ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ", "warning");
        }
    } else {
        logMessage("ç®¡ç†è€…æ¨©é™ã§èµ·å‹•ã—ã¦ã„ã¾ã™ - å…¨æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™", "success");
    }

    // ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ï¼ˆv2.1.0ä»¥é™ï¼‰
    loadAllTasks();

    // æ—§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®äº’æ›æ€§å‡¦ç†ï¼ˆv2.0.0ä»¥å‰ï¼‰
    // loadConfig();  // å°†æ¥çš„ã«ç§»è¡Œå‡¦ç†ã‚’è¿½åŠ äºˆå®š

    // ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    updateTaskStatus();

    // ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹ã‚’ç¢ºèªï¼ˆèµ·å‹•æ™‚ï¼‰
    getTaskHistoryStatus(true); // true = ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    setupEventListeners();
};

function setupEventListeners() {
    // ã‚³ãƒ”ãƒ¼å…ƒãƒ»å…ˆã®å¤‰æ›´ã§èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    document.getElementById('source').onchange = updateAuthState;
    document.getElementById('dest').onchange = function() {
        updateAuthState();
        updateTaskNameFromDest();
    };
}

// ======================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ======================================

function logMessage(message, type) {
    var logArea = document.getElementById('logArea');
    var timestamp = new Date().toLocaleString('ja-JP');
    var prefix = "";

    if (type === "error") prefix = "[ERROR] ";
    else if (type === "success") prefix = "[SUCCESS] ";
    else if (type === "warning") prefix = "[WARNING] ";
    else prefix = "[INFO] ";

    logArea.value += timestamp + " " + prefix + message + "\n";
    logArea.scrollTop = logArea.scrollHeight;
}

function isAdmin() {
    try {
        var result = shell.Run('net session', 0, true);
        return result === 0;
    } catch(e) {
        return false;
    }
}

function runAsAdmin() {
    try {
        // ç¾åœ¨ã®HTAãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
        var htaPath = location.pathname.substring(1);

        // ä¸€æ™‚VBScriptã‚’ä½œæˆã—ã¦ç®¡ç†è€…æ¨©é™ã§å†èµ·å‹•
        var vbsPath = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_elevate.vbs");

        var vbsContent = 'Set objShell = CreateObject("Shell.Application")\n';
        vbsContent += 'objShell.ShellExecute "mshta.exe", """' + htaPath + '""", "", "runas", 1\n';

        var vbsFile = fso.CreateTextFile(vbsPath, true, false);
        vbsFile.Write(vbsContent);
        vbsFile.Close();

        // VBScriptã‚’å®Ÿè¡Œ
        shell.Run('wscript.exe "' + vbsPath + '"', 0, false);

        // ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
        window.close();

    } catch(e) {
        logMessage("ç®¡ç†è€…æ¨©é™æ˜‡æ ¼ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ç®¡ç†è€…æ¨©é™ã§ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\næ‰‹å‹•ã§ç®¡ç†è€…æ¨©é™ã§ã®èµ·å‹•ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚");
    }
}

function isNetworkPath(path) {
    return path && path.indexOf("\\\\") === 0;
}

function updateAuthState() {
    var sourcePath = document.getElementById('source').value;
    var destPath = document.getElementById('dest').value;

    // ã‚³ãƒ”ãƒ¼å…ƒèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    var sourceAuthSection = document.getElementById('sourceAuthSection');
    if (isNetworkPath(sourcePath)) {
        sourceAuthSection.classList.remove('disabled');
    } else {
        sourceAuthSection.classList.add('disabled');
    }

    // ã‚³ãƒ”ãƒ¼å…ˆèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    var destAuthSection = document.getElementById('destAuthSection');
    if (isNetworkPath(destPath)) {
        destAuthSection.classList.remove('disabled');
    } else {
        destAuthSection.classList.add('disabled');
    }
}

function updateTaskNameFromDest() {
    var destPath = document.getElementById('dest').value;
    if (!destPath) return;

    try {
        // ãƒ‘ã‚¹ã®æœ€å¾Œã®éƒ¨åˆ†ï¼ˆãƒ•ã‚©ãƒ«ãƒ€åï¼‰ã‚’å–å¾—
        var folderName = fso.GetFileName(destPath);

        // ç©ºã®å ´åˆã¯ãƒ‰ãƒ©ã‚¤ãƒ–åãªã©ã‚’ä½¿ç”¨
        if (!folderName) {
            folderName = destPath.replace(/:/g, '').replace(/\\/g, '_');
        }

        // ã‚¿ã‚¹ã‚¯åã«ä½¿ç”¨ã§ããªã„æ–‡å­—ã‚’é™¤å»ãƒ»ç½®æ›
        var invalidChars = '<>:"/\\|?*';
        for (var i = 0; i < invalidChars.length; i++) {
            folderName = folderName.split(invalidChars[i]).join('_');
        }

        // ç©ºç™½ã‚’å«ã‚€å ´åˆã¯ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«ç½®æ›
        folderName = folderName.split(' ').join('_');

        // æœ€å¤§é•·åˆ¶é™
        if (folderName.length > 50) {
            folderName = folderName.substring(0, 50);
        }

        document.getElementById('taskName').value = folderName + "-Robocopy";

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯åç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

function updateWeekdayState() {
    var frequency = document.querySelector('input[name="frequency"]:checked').value;
    var weekdaySection = document.getElementById('weekdaySection');

    if (frequency === "WEEKLY") {
        weekdaySection.style.display = "block";
    } else {
        weekdaySection.style.display = "none";
    }
}

function toggleEmailSettings() {
    var emailEnabled = document.getElementById('emailEnabled').checked;
    var emailSettings = document.getElementById('emailSettings');

    if (emailEnabled) {
        emailSettings.style.display = "block";
    } else {
        emailSettings.style.display = "none";
    }
}

// ======================================
// ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€å‚ç…§
// ======================================

function browseFolder(targetId) {
    try {
        var folder = shellApp.BrowseForFolder(0, "ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„", 0);
        if (folder) {
            var folderPath = folder.Self.Path;
            document.getElementById(targetId).value = folderPath;

            // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
            if (targetId === 'source' || targetId === 'dest') {
                updateAuthState();
                if (targetId === 'dest') {
                    updateTaskNameFromDest();
                }
            }
        }
    } catch(e) {
        logMessage("ãƒ•ã‚©ãƒ«ãƒ€å‚ç…§ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

function browseFile(targetId) {
    try {
        // HTAã®åˆ¶ç´„ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯æ‰‹å…¥åŠ›ã§ä»£æ›¿
        var currentValue = document.getElementById(targetId).value;
        var defaultValue = currentValue || "C:\\Logs\\robocopy.log";

        var selectedFile = prompt("ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", defaultValue);
        if (selectedFile) {
            document.getElementById(targetId).value = selectedFile;
        }
    } catch(e) {
        logMessage("ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

// ======================================
// è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
// ======================================

function saveConfig() {
    try {
        var config = {
            source: document.getElementById('source').value,
            dest: document.getElementById('dest').value,
            task_name: document.getElementById('taskName').value,
            copy_mode: document.querySelector('input[name="copyMode"]:checked').value,
            robocopy_options: {
                no_progress: document.getElementById('optNoProgress').checked,
                no_dir_list: document.getElementById('optNoDirList').checked,
                sec: document.getElementById('optSec').checked,
                list_only: document.getElementById('optListOnly').checked,
                enable_log: document.getElementById('optEnableLog').checked
            },
            retry_count: document.getElementById('retryCount').value,
            wait_time: document.getElementById('waitTime').value,
            log_file: document.getElementById('logFile').value,
            custom_options: document.getElementById('customOptions').value,
            frequency: document.querySelector('input[name="frequency"]:checked').value,
            weekday: getSelectedWeekdays(),
            hour: document.getElementById('hour').value,
            minute: document.getElementById('minute').value,
            email_enabled: document.getElementById('emailEnabled').checked,
            smtp_server: document.getElementById('smtpServer').value,
            smtp_port: document.getElementById('smtpPort').value,
            connection_security: document.getElementById('connectionSecurity').value,
            auth_method: document.getElementById('authMethod').value,
            sender_email: document.getElementById('senderEmail').value,
            sender_password: document.getElementById('senderPassword').value,
            recipient_email: document.getElementById('recipientEmail').value,
            history_enabled: document.getElementById('historyEnabled').checked,
            source_username: document.getElementById('sourceUsername').value,
            source_password: document.getElementById('sourcePassword').value,
            source_domain: document.getElementById('sourceDomain').value,
            dest_username: document.getElementById('destUsername').value,
            dest_password: document.getElementById('destPassword').value,
            dest_domain: document.getElementById('destDomain').value
        };

        var configJson = JSON.stringify(config, null, 2);

        var configPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)), CONFIG_FILE);
        var file = fso.CreateTextFile(configPath, true, false);
        file.Write(configJson);
        file.Close();

        logMessage("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ: " + configPath, "success");
        return true;
    } catch(e) {
        logMessage("è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        return false;
    }
}

function loadConfig() {
    try {
        var configPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)), CONFIG_FILE);

        if (!fso.FileExists(configPath)) {
            logMessage("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            return;
        }

        var file = fso.OpenTextFile(configPath, 1, false);
        var configJson = file.ReadAll();
        file.Close();

        var config = JSON.parse(configJson);

        // è¨­å®šã‚’å¾©å…ƒ
        if (config.source) document.getElementById('source').value = config.source;
        if (config.dest) document.getElementById('dest').value = config.dest;
        if (config.task_name) document.getElementById('taskName').value = config.task_name;

        if (config.copy_mode) {
            var radios = document.getElementsByName('copyMode');
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].value === config.copy_mode) {
                    radios[i].checked = true;
                }
            }
        }

        if (config.robocopy_options) {
            document.getElementById('optNoProgress').checked = config.robocopy_options.no_progress || false;
            document.getElementById('optNoDirList').checked = config.robocopy_options.no_dir_list || false;
            document.getElementById('optSec').checked = config.robocopy_options.sec || false;
            document.getElementById('optListOnly').checked = config.robocopy_options.list_only || false;
            document.getElementById('optEnableLog').checked = config.robocopy_options.enable_log || false;
        }

        if (config.retry_count) document.getElementById('retryCount').value = config.retry_count;
        if (config.wait_time) document.getElementById('waitTime').value = config.wait_time;
        if (config.log_file) document.getElementById('logFile').value = config.log_file;
        if (config.custom_options) document.getElementById('customOptions').value = config.custom_options;

        if (config.frequency) {
            var freqRadios = document.getElementsByName('frequency');
            for (var i = 0; i < freqRadios.length; i++) {
                if (freqRadios[i].value === config.frequency) {
                    freqRadios[i].checked = true;
                }
            }
            updateWeekdayState();
        }

        if (config.weekday) {
            setSelectedWeekdays(config.weekday);
        }

        if (config.hour) document.getElementById('hour').value = config.hour;
        if (config.minute) document.getElementById('minute').value = config.minute;

        if (config.email_enabled !== undefined) {
            document.getElementById('emailEnabled').checked = config.email_enabled;
            toggleEmailSettings();
        }

        if (config.smtp_server) document.getElementById('smtpServer').value = config.smtp_server;
        if (config.smtp_port) document.getElementById('smtpPort').value = config.smtp_port;
        if (config.connection_security) document.getElementById('connectionSecurity').value = config.connection_security;
        if (config.auth_method) document.getElementById('authMethod').value = config.auth_method;
        if (config.sender_email) document.getElementById('senderEmail').value = config.sender_email;
        if (config.sender_password) document.getElementById('senderPassword').value = config.sender_password;
        if (config.recipient_email) document.getElementById('recipientEmail').value = config.recipient_email;

        if (config.history_enabled !== undefined) {
            document.getElementById('historyEnabled').checked = config.history_enabled;
        }

        if (config.source_username) document.getElementById('sourceUsername').value = config.source_username;
        if (config.source_password) document.getElementById('sourcePassword').value = config.source_password;
        if (config.source_domain) document.getElementById('sourceDomain').value = config.source_domain;
        if (config.dest_username) document.getElementById('destUsername').value = config.dest_username;
        if (config.dest_password) document.getElementById('destPassword').value = config.dest_password;
        if (config.dest_domain) document.getElementById('destDomain').value = config.dest_domain;

        // èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
        updateAuthState();

        logMessage("è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: " + configPath, "success");
    } catch(e) {
        logMessage("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

// ======================================
// ã‚¿ã‚¹ã‚¯ç®¡ç†é–¢æ•°
// ======================================

// ã‚¿ã‚¹ã‚¯IDã‚’ç”Ÿæˆï¼ˆtask_ + ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ©ãƒ³ãƒ€ãƒ 3æ¡ï¼‰
function generateTaskId() {
    var timestamp = new Date().getTime();
    var random = Math.floor(Math.random() * 1000);
    return "task_" + timestamp + "_" + String(random).padStart(3, '0');
}

// ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’å–å¾—
function getTasksFolder() {
    var appFolder = fso.GetParentFolderName(location.pathname.substring(1));
    return fso.BuildPath(appFolder, TASKS_FOLDER);
}

// ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
function getTaskFilePath(taskId) {
    return fso.BuildPath(getTasksFolder(), taskId + ".json");
}

// ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€
function loadAllTasks() {
    try {
        tasks = [];  // ã‚¿ã‚¹ã‚¯é…åˆ—ã‚’ã‚¯ãƒªã‚¢
        var tasksFolder = getTasksFolder();

        // ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if (!fso.FolderExists(tasksFolder)) {
            fso.CreateFolder(tasksFolder);
            logMessage("ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ: " + tasksFolder);
            return;
        }

        // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        var folder = fso.GetFolder(tasksFolder);
        var files = new Enumerator(folder.Files);
        var count = 0;

        for (; !files.atEnd(); files.moveNext()) {
            var file = files.item();
            if (file.Name.toLowerCase().endsWith('.json')) {
                try {
                    var taskId = file.Name.substring(0, file.Name.length - 5);  // .jsonã‚’é™¤å»
                    var task = loadTask(taskId);
                    if (task) {
                        tasks.push(task);
                        count++;
                    }
                } catch(e) {
                    logMessage("ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (" + file.Name + "): " + e.message, "error");
                }
            }
        }

        logMessage("ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: " + count + "ä»¶", "success");

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆUIã‚’æ›´æ–°
        refreshTaskList();
    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

// ç‰¹å®šã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€
function loadTask(taskId) {
    try {
        var filePath = getTaskFilePath(taskId);

        if (!fso.FileExists(filePath)) {
            logMessage("ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + taskId, "warning");
            return null;
        }

        var file = fso.OpenTextFile(filePath, 1, false);
        var taskJson = file.ReadAll();
        file.Close();

        var task = JSON.parse(taskJson);

        // ã‚¿ã‚¹ã‚¯IDãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
        if (!task.id) {
            task.id = taskId;
        }

        return task;
    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (" + taskId + "): " + e.message, "error");
        return null;
    }
}

// ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
function saveTask(task) {
    try {
        // ã‚¿ã‚¹ã‚¯IDãŒæœªè¨­å®šã®å ´åˆã¯ç”Ÿæˆ
        if (!task.id) {
            task.id = generateTaskId();
        }

        // ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        var tasksFolder = getTasksFolder();
        if (!fso.FolderExists(tasksFolder)) {
            fso.CreateFolder(tasksFolder);
        }

        var filePath = getTaskFilePath(task.id);
        var taskJson = JSON.stringify(task, null, 2);

        var file = fso.CreateTextFile(filePath, true, false);
        file.Write(taskJson);
        file.Close();

        logMessage("ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ: " + task.name + " (" + task.id + ")", "success");
        return task.id;
    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        return null;
    }
}

// ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
function deleteTask(taskId) {
    try {
        var filePath = getTaskFilePath(taskId);

        if (!fso.FileExists(filePath)) {
            logMessage("å‰Šé™¤å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + taskId, "warning");
            return false;
        }

        fso.DeleteFile(filePath);

        // tasksé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
        for (var i = 0; i < tasks.length; i++) {
            if (tasks[i].id === taskId) {
                tasks.splice(i, 1);
                break;
            }
        }

        logMessage("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: " + taskId, "success");
        return true;
    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        return false;
    }
}

// ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆIDã®é…åˆ—ï¼‰
function getTaskList() {
    var taskIds = [];
    for (var i = 0; i < tasks.length; i++) {
        taskIds.push(tasks[i].id);
    }
    return taskIds;
}

// ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å†æç”»
function refreshTaskList() {
    var taskListArea = document.getElementById('taskListArea');
    var emptyState = document.getElementById('emptyTaskState');
    var taskCount = document.getElementById('taskCount');

    // ã‚¿ã‚¹ã‚¯æ•°ã‚’æ›´æ–°
    taskCount.textContent = '(' + tasks.length + 'ä»¶)';

    // ã‚¿ã‚¹ã‚¯ãŒãªã„å ´åˆã¯ç©ºã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    if (tasks.length === 0) {
        taskListArea.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    // ç©ºã®çŠ¶æ…‹ã‚’éè¡¨ç¤º
    emptyState.style.display = 'none';

    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    var html = '';
    for (var i = 0; i < tasks.length; i++) {
        html += renderTaskCard(tasks[i]);
    }
    taskListArea.innerHTML = html;
}

// ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
function renderTaskCard(task) {
    var enabled = task.enabled !== false;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ‰åŠ¹
    var disabledClass = enabled ? '' : ' disabled';
    var statusClass = enabled ? 'active' : 'inactive';
    var statusText = enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
    var checked = enabled ? ' checked' : '';

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’ç”Ÿæˆ
    var scheduleText = '';
    if (task.schedule) {
        if (task.schedule.frequency === 'DAILY') {
            scheduleText = 'æ¯æ—¥';
        } else if (task.schedule.frequency === 'WEEKLY') {
            scheduleText = 'æ¯é€± ' + (task.schedule.weekday || '');
        }
        scheduleText += ' ' + (task.schedule.hour || '00') + ':' + (task.schedule.minute || '00') + ' å®Ÿè¡Œ';
    }

    // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰æƒ…å ±
    var modeText = task.copy_mode || 'MIR';
    scheduleText += ' | /' + modeText + ' ãƒ¢ãƒ¼ãƒ‰';

    // ãƒ­ã‚°æœ‰åŠ¹/ç„¡åŠ¹
    var logEnabled = task.robocopy_options && task.robocopy_options.enable_log !== false;
    scheduleText += ' | ãƒ­ã‚°' + (logEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹');

    var html = '<div class="task-card' + disabledClass + '" data-task-id="' + task.id + '">';
    html += '  <div class="task-header">';
    html += '    <div class="task-title">';
    html += '      <input type="checkbox"' + checked + ' onchange="toggleTaskEnabled(\'' + task.id + '\')">';
    html += '      <h3>' + (task.name || 'ã‚¿ã‚¹ã‚¯åãªã—') + '</h3>';
    html += '      <span class="task-status ' + statusClass + '">' + statusText + '</span>';
    html += '    </div>';
    html += '  </div>';
    html += '  <div class="task-info">';
    html += '    <div class="task-path">';
    html += '      <div class="task-path-item">' + (task.source || '') + '</div>';
    html += '      <span class="task-arrow">â†’</span>';
    html += '      <div class="task-path-item">' + (task.dest || '') + '</div>';
    html += '    </div>';
    html += '    <div class="task-schedule">';
    html += '      <span class="task-schedule-icon">â°</span>';
    html += '      <span>' + scheduleText + '</span>';
    html += '    </div>';
    html += '  </div>';
    html += '  <div class="task-actions">';
    html += '    <button class="btn btn-primary btn-small" onclick="registerTaskById(\'' + task.id + '\')">ğŸ“ ç™»éŒ²</button>';
    html += '    <button class="btn btn-secondary btn-small" onclick="editTaskById(\'' + task.id + '\')">âœï¸ ç·¨é›†</button>';
    html += '    <button class="btn btn-success btn-small" onclick="testTaskById(\'' + task.id + '\')">â–¶ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>';
    html += '    <button class="btn btn-danger btn-small" onclick="deleteTaskById(\'' + task.id + '\')">ğŸ—‘ï¸ å‰Šé™¤</button>';
    html += '  </div>';
    html += '</div>';

    return html;
}

// ã‚¿ã‚¹ã‚¯ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
function toggleTaskEnabled(taskId) {
    for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === taskId) {
            tasks[i].enabled = !tasks[i].enabled;
            saveTask(tasks[i]);
            refreshTaskList();
            logMessage('ã‚¿ã‚¹ã‚¯ "' + tasks[i].name + '" ã‚’' + (tasks[i].enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹') + 'ã«ã—ã¾ã—ãŸ');
            break;
        }
    }
}

// ã‚¿ã‚¹ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
function testTaskById(taskId) {
    // ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
    var task = null;
    for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === taskId) {
            task = tasks[i];
            break;
        }
    }

    if (!task) {
        alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + taskId);
        return;
    }

    // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ä¸€æ™‚çš„ã«èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ
    // ï¼ˆæ—¢å­˜ã®generateBatchScript()ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
    var originalTask = getTaskFromForm();  // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿å­˜
    loadTaskToForm(task);  // ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚¿ã‚¹ã‚¯ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã¿

    try {
        var batchScript = generateBatchScript();

        // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
        var tempBatchPath = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_test_" + task.id + ".bat");
        var batchFile = fso.CreateTextFile(tempBatchPath, true, false);
        batchFile.Write(batchScript);
        batchFile.Close();

        // ãƒ¡ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ç”Ÿæˆï¼ˆãƒ¡ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªå ´åˆï¼‰
        if (task.email_enabled) {
            var mailScript = generateMailScript();
            var tempPs1Path = fso.BuildPath(fso.GetSpecialFolder(2), "send_robocopy_mail.ps1");
            var ps1File = fso.CreateTextFile(tempPs1Path, true, true);  // Unicode
            ps1File.Write(mailScript);
            ps1File.Close();
        }

        logMessage('ã‚¿ã‚¹ã‚¯ "' + task.name + '" ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™...', 'success');

        // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
        shell.Run('"' + tempBatchPath + '"', 1, false);

        logMessage('ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ: ' + tempBatchPath);

    } catch(e) {
        logMessage('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        alert('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' + e.message);
    } finally {
        // å…ƒã®ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆç·¨é›†ä¸­ã®å ´åˆï¼‰
        if (currentEditingTaskId) {
            loadTaskToForm(originalTask);
        }
    }
}

// ã‚¿ã‚¹ã‚¯ã‚’Windowsã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ç™»éŒ²
function registerTaskById(taskId) {
    // ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
    var task = null;
    for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === taskId) {
            task = tasks[i];
            break;
        }
    }

    if (!task) {
        alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + taskId);
        return;
    }

    if (!isAdmin()) {
        alert("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
        return;
    }

    // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ä¸€æ™‚çš„ã«èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
    var originalTask = getTaskFromForm();  // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿å­˜
    loadTaskToForm(task);  // ç™»éŒ²å¯¾è±¡ã‚¿ã‚¹ã‚¯ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã¿

    try {
        logMessage('ã‚¿ã‚¹ã‚¯ "' + task.name + '" ã‚’Windowsã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã«ç™»éŒ²ã—ã¾ã™...');

        // æ—¢å­˜ã®createScheduledTask()é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        createScheduledTask();

    } catch(e) {
        logMessage('ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        alert('ã‚¿ã‚¹ã‚¯ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' + e.message);
    } finally {
        // å…ƒã®ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆç·¨é›†ä¸­ã®å ´åˆï¼‰
        if (currentEditingTaskId) {
            loadTaskToForm(originalTask);
        }
    }
}

// ã‚¿ã‚¹ã‚¯å‰Šé™¤
function deleteTaskById(taskId) {
    if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        if (deleteTask(taskId)) {
            refreshTaskList();
        }
    }
}

// ======================================
// ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ»ç·¨é›†æ©Ÿèƒ½
// ======================================

var currentEditingTaskId = null;  // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯IDï¼ˆnullã®å ´åˆã¯æ–°è¦è¿½åŠ ï¼‰

// ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
function showAddTaskDialog() {
    currentEditingTaskId = null;
    clearTaskForm();
    document.getElementById('taskEditorSection').style.display = 'block';
    document.getElementById('taskListArea').parentElement.style.display = 'none';

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã®å…ˆé ­ã«ç§»å‹•
    document.getElementById('taskEditorSection').scrollIntoView({ behavior: 'smooth' });

    logMessage('æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã—ãŸ');
}

// ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
function editTaskById(taskId) {
    // ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
    var task = null;
    for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === taskId) {
            task = tasks[i];
            break;
        }
    }

    if (!task) {
        alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + taskId);
        return;
    }

    currentEditingTaskId = taskId;
    loadTaskToForm(task);
    document.getElementById('taskEditorSection').style.display = 'block';
    document.getElementById('taskListArea').parentElement.style.display = 'none';

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã®å…ˆé ­ã«ç§»å‹•
    document.getElementById('taskEditorSection').scrollIntoView({ behavior: 'smooth' });

    logMessage('ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ' + task.name);
}

// ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
function saveCurrentTask() {
    try {
        var task = getTaskFromForm();

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!task.name || task.name.trim() === '') {
            alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if (!task.source || task.source.trim() === '') {
            alert('ã‚³ãƒ”ãƒ¼å…ƒãƒ•ã‚©ãƒ«ãƒ€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if (!task.dest || task.dest.trim() === '') {
            alert('ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯IDãŒã‚ã‚Œã°è¨­å®š
        if (currentEditingTaskId) {
            task.id = currentEditingTaskId;
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
        var taskId = saveTask(task);

        if (taskId) {
            // tasksé…åˆ—ã‚’æ›´æ–°
            if (currentEditingTaskId) {
                // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
                for (var i = 0; i < tasks.length; i++) {
                    if (tasks[i].id === currentEditingTaskId) {
                        tasks[i] = task;
                        break;
                    }
                }
            } else {
                // æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
                task.id = taskId;
                tasks.push(task);
            }

            // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‰ã˜ã‚‹
            refreshTaskList();
            cancelTaskEdit();

            logMessage('ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + task.name, 'success');
        }
    } catch(e) {
        logMessage('ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        alert('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' + e.message);
    }
}

// ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦é–‰ã˜ã‚‹
function cancelTaskEdit() {
    currentEditingTaskId = null;
    document.getElementById('taskEditorSection').style.display = 'none';
    document.getElementById('taskListArea').parentElement.style.display = 'block';
    logMessage('ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
}

// ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã‚€
function loadTaskToForm(task) {
    // åŸºæœ¬è¨­å®š
    document.getElementById('source').value = task.source || '';
    document.getElementById('dest').value = task.dest || '';
    document.getElementById('taskName').value = task.name || '';

    // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰
    var copyModeRadios = document.getElementsByName('copyMode');
    for (var i = 0; i < copyModeRadios.length; i++) {
        copyModeRadios[i].checked = (copyModeRadios[i].value === (task.copy_mode || 'MIR'));
    }

    // Robocopyã‚ªãƒ—ã‚·ãƒ§ãƒ³
    if (task.robocopy_options) {
        document.getElementById('optNoProgress').checked = task.robocopy_options.no_progress || false;
        document.getElementById('optNoDirList').checked = task.robocopy_options.no_dir_list || false;
        document.getElementById('optSec').checked = task.robocopy_options.sec || false;
        document.getElementById('optListOnly').checked = task.robocopy_options.list_only || false;
        document.getElementById('optEnableLog').checked = task.robocopy_options.enable_log !== false;
    }

    // ãƒªãƒˆãƒ©ã‚¤è¨­å®š
    document.getElementById('retryCount').value = task.retry_count || 3;
    document.getElementById('waitTime').value = task.wait_time || 10;
    document.getElementById('logFile').value = task.log_file || '';
    document.getElementById('customOptions').value = task.custom_options || '';

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
    if (task.schedule) {
        var freqRadios = document.getElementsByName('frequency');
        for (var i = 0; i < freqRadios.length; i++) {
            freqRadios[i].checked = (freqRadios[i].value === (task.schedule.frequency || 'DAILY'));
        }
        updateWeekdayState();

        if (task.schedule.weekday) {
            setSelectedWeekdays(task.schedule.weekday);
        }

        document.getElementById('hour').value = task.schedule.hour || '00';
        document.getElementById('minute').value = task.schedule.minute || '00';
    }

    // ãƒ¡ãƒ¼ãƒ«è¨­å®š
    document.getElementById('emailEnabled').checked = task.email_enabled || false;
    toggleEmailSettings();

    if (task.smtp_server) document.getElementById('smtpServer').value = task.smtp_server;
    if (task.smtp_port) document.getElementById('smtpPort').value = task.smtp_port;
    if (task.connection_security) document.getElementById('connectionSecurity').value = task.connection_security;
    if (task.auth_method) document.getElementById('authMethod').value = task.auth_method;
    if (task.sender_email) document.getElementById('senderEmail').value = task.sender_email;
    if (task.sender_password) document.getElementById('senderPassword').value = task.sender_password;
    if (task.recipient_email) document.getElementById('recipientEmail').value = task.recipient_email;

    // ã‚¿ã‚¹ã‚¯å±¥æ­´
    document.getElementById('historyEnabled').checked = task.history_enabled || false;

    // èªè¨¼æƒ…å ±
    if (task.source_username) document.getElementById('sourceUsername').value = task.source_username;
    if (task.source_password) document.getElementById('sourcePassword').value = task.source_password;
    if (task.source_domain) document.getElementById('sourceDomain').value = task.source_domain;
    if (task.dest_username) document.getElementById('destUsername').value = task.dest_username;
    if (task.dest_password) document.getElementById('destPassword').value = task.dest_password;
    if (task.dest_domain) document.getElementById('destDomain').value = task.dest_domain;

    // èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
    updateAuthState();
}

// ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
function getTaskFromForm() {
    var task = {
        name: document.getElementById('taskName').value,
        enabled: true,  // æ–°è¦ä½œæˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹
        source: document.getElementById('source').value,
        dest: document.getElementById('dest').value,
        copy_mode: document.querySelector('input[name="copyMode"]:checked').value,
        robocopy_options: {
            no_progress: document.getElementById('optNoProgress').checked,
            no_dir_list: document.getElementById('optNoDirList').checked,
            sec: document.getElementById('optSec').checked,
            list_only: document.getElementById('optListOnly').checked,
            enable_log: document.getElementById('optEnableLog').checked
        },
        retry_count: document.getElementById('retryCount').value,
        wait_time: document.getElementById('waitTime').value,
        log_file: document.getElementById('logFile').value,
        custom_options: document.getElementById('customOptions').value,
        schedule: {
            frequency: document.querySelector('input[name="frequency"]:checked').value,
            weekday: getSelectedWeekdays(),
            hour: document.getElementById('hour').value,
            minute: document.getElementById('minute').value
        },
        email_enabled: document.getElementById('emailEnabled').checked,
        smtp_server: document.getElementById('smtpServer').value,
        smtp_port: document.getElementById('smtpPort').value,
        connection_security: document.getElementById('connectionSecurity').value,
        auth_method: document.getElementById('authMethod').value,
        sender_email: document.getElementById('senderEmail').value,
        sender_password: document.getElementById('senderPassword').value,
        recipient_email: document.getElementById('recipientEmail').value,
        history_enabled: document.getElementById('historyEnabled').checked,
        source_username: document.getElementById('sourceUsername').value,
        source_password: document.getElementById('sourcePassword').value,
        source_domain: document.getElementById('sourceDomain').value,
        dest_username: document.getElementById('destUsername').value,
        dest_password: document.getElementById('destPassword').value,
        dest_domain: document.getElementById('destDomain').value
    };

    return task;
}

// ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
function clearTaskForm() {
    document.getElementById('source').value = '';
    document.getElementById('dest').value = '';
    document.getElementById('taskName').value = '';
    document.getElementById('retryCount').value = '3';
    document.getElementById('waitTime').value = '10';
    document.getElementById('logFile').value = '';
    document.getElementById('customOptions').value = '';
    document.getElementById('hour').value = '00';
    document.getElementById('minute').value = '00';

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
    document.getElementById('optNoProgress').checked = true;
    document.getElementById('optNoDirList').checked = true;
    document.getElementById('optSec').checked = false;
    document.getElementById('optListOnly').checked = false;
    document.getElementById('optEnableLog').checked = true;
    document.getElementById('emailEnabled').checked = false;
    document.getElementById('historyEnabled').checked = false;

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
    document.querySelector('input[name="copyMode"][value="MIR"]').checked = true;
    document.querySelector('input[name="frequency"][value="DAILY"]').checked = true;

    // èªè¨¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('sourceUsername').value = '';
    document.getElementById('sourcePassword').value = '';
    document.getElementById('sourceDomain').value = '';
    document.getElementById('destUsername').value = '';
    document.getElementById('destPassword').value = '';
    document.getElementById('destDomain').value = '';

    // ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’ã‚¯ãƒªã‚¢
    document.getElementById('smtpServer').value = '';
    document.getElementById('smtpPort').value = '587';
    document.getElementById('connectionSecurity').value = 'STARTTLS';
    document.getElementById('authMethod').value = 'PLAIN';
    document.getElementById('senderEmail').value = '';
    document.getElementById('senderPassword').value = '';
    document.getElementById('recipientEmail').value = '';

    // UIçŠ¶æ…‹ã‚’æ›´æ–°
    updateAuthState();
    toggleEmailSettings();
    updateWeekdayState();
}

function getSelectedWeekdays() {
    var checkboxes = document.querySelectorAll('.week-grid input[type="checkbox"]:checked');
    var weekdays = [];
    for (var i = 0; i < checkboxes.length; i++) {
        weekdays.push(checkboxes[i].value);
    }
    return weekdays.join(',');
}

function setSelectedWeekdays(weekdayStr) {
    if (!weekdayStr) return;

    var weekdays = weekdayStr.split(',');
    var checkboxes = document.querySelectorAll('.week-grid input[type="checkbox"]');

    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
        for (var j = 0; j < weekdays.length; j++) {
            if (checkboxes[i].value === weekdays[j]) {
                checkboxes[i].checked = true;
            }
        }
    }
}

// ======================================
// Robocopyã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ
// ======================================

function buildRobocopyOptions(forGui) {
    var options = [];

    // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰
    var copyMode = document.querySelector('input[name="copyMode"]:checked').value;
    if (copyMode === "MIR") {
        options.push("/MIR");
    } else {
        options.push("/E");
    }

    // ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    if (document.getElementById('optNoProgress').checked) {
        options.push("/NP");
    }

    if (document.getElementById('optNoDirList').checked) {
        options.push("/NDL");
    }

    if (document.getElementById('optSec').checked) {
        options.push("/SEC");
    }

    if (document.getElementById('optListOnly').checked && forGui) {
        options.push("/L");
    }

    // ãƒªãƒˆãƒ©ã‚¤è¨­å®š
    var retryCount = document.getElementById('retryCount').value;
    var waitTime = document.getElementById('waitTime').value;

    if (retryCount) {
        options.push("/R:" + retryCount);
    }

    if (waitTime) {
        options.push("/W:" + waitTime);
    }

    // ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    var customOptions = document.getElementById('customOptions').value.trim();
    if (customOptions) {
        options.push(customOptions);
    }

    return options.join(" ");
}

// ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰Robocopyã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
function buildRobocopyOptionsFromTask(task, forGui) {
    var options = [];

    // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰
    var copyMode = task.copy_mode || "MIR";
    if (copyMode === "MIR") {
        options.push("/MIR");
    } else {
        options.push("/E");
    }

    // ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    if (task.robocopy_options) {
        if (task.robocopy_options.no_progress) {
            options.push("/NP");
        }
        if (task.robocopy_options.no_dir_list) {
            options.push("/NDL");
        }
        if (task.robocopy_options.sec) {
            options.push("/SEC");
        }
        if (task.robocopy_options.list_only && forGui) {
            options.push("/L");
        }
    }

    // ãƒªãƒˆãƒ©ã‚¤è¨­å®š
    if (task.retry_count) {
        options.push("/R:" + task.retry_count);
    }
    if (task.wait_time) {
        options.push("/W:" + task.wait_time);
    }

    // ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    if (task.custom_options && task.custom_options.trim()) {
        options.push(task.custom_options.trim());
    }

    return options.join(" ");
}

function escapeBatchPassword(password) {
    if (!password) return "";

    // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    password = password.replace(/\^/g, "^^");
    password = password.replace(/%/g, "%%");
    password = password.replace(/&/g, "^&");
    password = password.replace(/</g, "^<");
    password = password.replace(/>/g, "^>");
    password = password.replace(/\|/g, "^|");
    password = password.replace(/"/g, '""');

    return password;
}

function escapeBatchString(str) {
    if (!str) return "";

    // % ã‚’ %% ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    str = str.replace(/%/g, "%%");

    return str;
}

function escapePowerShellString(str) {
    if (!str) return "";

    // PowerShellç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    str = str.replace(/'/g, "''");
    str = str.replace(/`/g, "``");
    str = str.replace(/\$/g, "`$");

    return str;
}

// ======================================
// ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
// ======================================

function generateBatchScript() {
    var now = new Date();
    var dateStr = now.getFullYear() + "-" +
                  padZero(now.getMonth() + 1) + "-" +
                  padZero(now.getDate()) + " " +
                  padZero(now.getHours()) + ":" +
                  padZero(now.getMinutes()) + ":" +
                  padZero(now.getSeconds());

    var source = document.getElementById('source').value;
    var dest = document.getElementById('dest').value;
    var options = buildRobocopyOptions(false);

    // ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆæ‹¡å¼µå­ãªã—ï¼‰
    var baseLogFile = document.getElementById('logFile').value || "robocopy_schedule_log";
    if (baseLogFile.toLowerCase().indexOf('.txt') === baseLogFile.length - 4) {
        baseLogFile = baseLogFile.substring(0, baseLogFile.length - 4);
    }
    // çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    if (!fso.FileExists(baseLogFile) && baseLogFile.indexOf('\\') === -1 && baseLogFile.indexOf(':') === -1) {
        baseLogFile = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)), baseLogFile);
    }

    var batch = "@echo off\r\n";
    batch += "chcp 932 >nul\r\n";
    batch += "setlocal enabledelayedexpansion\r\n";
    batch += "\r\n";
    batch += ":: ===========================================\r\n";
    batch += ":: Robocopyè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ\r\n";
    batch += ":: ç”Ÿæˆæ—¥æ™‚: " + dateStr + "\r\n";
    batch += ":: ===========================================\r\n";
    batch += "\r\n";
    batch += "set ERROR_OCCURRED=0\r\n";
    batch += "\r\n";
    batch += ":: å®Ÿè¡Œæ¯ã«ä¸€æ„ãªãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ\r\n";
    batch += "for /f \"tokens=1-3 delims=/ \" %%a in (\"%date%\") do (\r\n";
    batch += "    set DATE_PART=%%a%%b%%c\r\n";
    batch += ")\r\n";
    batch += "for /f \"tokens=1-3 delims=:. \" %%a in (\"%time%\") do (\r\n";
    batch += "    set TIME_PART=%%a%%b%%c\r\n";
    batch += ")\r\n";
    batch += ":: æ™‚åˆ»ã®å…ˆé ­ã‚¹ãƒšãƒ¼ã‚¹ã‚’0ã«ç½®æ›\r\n";
    batch += "set TIME_PART=%TIME_PART: =0%\r\n";
    batch += "\r\n";
    batch += "set LOG_FILE=\"" + baseLogFile + "_%DATE_PART%_%TIME_PART%.txt\"\r\n";
    batch += "set TEMP_LOG=\"" + fso.GetParentFolderName(baseLogFile) + "\\robocopy_temp_%DATE_PART%_%TIME_PART%.log\"\r\n";
    batch += "\r\n";
    batch += ":: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‡ºåŠ›\r\n";
    batch += "echo =========================================== > %LOG_FILE%\r\n";
    batch += "echo Robocopyè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œãƒ­ã‚° >> %LOG_FILE%\r\n";
    batch += "echo å®Ÿè¡Œé–‹å§‹: %date% %time% >> %LOG_FILE%\r\n";
    batch += "echo =========================================== >> %LOG_FILE%\r\n";
    batch += "echo ã‚³ãƒ”ãƒ¼å…ƒ: " + source + " >> %LOG_FILE%\r\n";
    batch += "echo ã‚³ãƒ”ãƒ¼å…ˆ: " + dest + " >> %LOG_FILE%\r\n";
    batch += "echo. >> %LOG_FILE%\r\n";
    batch += "\r\n";

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ï¼ˆã‚³ãƒ”ãƒ¼å…ƒï¼‰
    if (isNetworkPath(source)) {
        var sourceUsername = document.getElementById('sourceUsername').value;
        var sourcePassword = document.getElementById('sourcePassword').value;
        var sourceDomain = document.getElementById('sourceDomain').value;

        if (sourceUsername) {
            var serverPath = "\\\\" + source.split("\\")[2];
            var username = escapeBatchString(sourceUsername);
            var password = escapeBatchPassword(sourcePassword);
            var domain = escapeBatchString(sourceDomain);
            var userPart = domain ? domain + "\\" + username : username;

            batch += ":: ã‚³ãƒ”ãƒ¼å…ƒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼\r\n";
            batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ƒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ä¸­... >> %LOG_FILE%\r\n";
            batch += "echo ã‚³ãƒ”ãƒ¼å…ƒã‚µãƒ¼ãƒãƒ¼: " + serverPath + " >> %LOG_FILE%\r\n";
            batch += "echo ãƒ¦ãƒ¼ã‚¶ãƒ¼: " + userPart + " >> %LOG_FILE%\r\n";
            batch += "\r\n";
            batch += ":: æ—¢å­˜ã®æ¥ç¶šã‚’åˆ‡æ–­\r\n";
            batch += "net use \"" + serverPath + "\" /delete /y >nul 2>&1\r\n";
            batch += "\r\n";
            batch += ":: æ–°ã—ã„æ¥ç¶šã‚’ç¢ºç«‹\r\n";
            batch += "net use \"" + serverPath + "\" " + password + " /user:\"" + userPart + "\" /persistent:no\r\n";
            batch += "if !errorlevel! neq 0 (\r\n";
            batch += "    echo [%date% %time%] ERROR: ã‚³ãƒ”ãƒ¼å…ƒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ã«å¤±æ•— ^(ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: !errorlevel!^) >> %LOG_FILE%\r\n";
            batch += "    echo è©³ç´°: net use ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ >> %LOG_FILE%\r\n";
            batch += "    set ERROR_OCCURRED=1\r\n";
            batch += "    goto :CLEANUP\r\n";
            batch += ")\r\n";
            batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ƒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼æˆåŠŸ >> %LOG_FILE%\r\n";
            batch += "\r\n";
        }
    }

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ï¼ˆã‚³ãƒ”ãƒ¼å…ˆï¼‰
    if (isNetworkPath(dest)) {
        var destUsername = document.getElementById('destUsername').value;
        var destPassword = document.getElementById('destPassword').value;
        var destDomain = document.getElementById('destDomain').value;

        if (destUsername) {
            var destServerPath = "\\\\" + dest.split("\\")[2];
            var username = escapeBatchString(destUsername);
            var password = escapeBatchPassword(destPassword);
            var domain = escapeBatchString(destDomain);
            var userPart = domain ? domain + "\\" + username : username;

            // ã‚³ãƒ”ãƒ¼å…ƒã¨åŒã˜ã‚µãƒ¼ãƒãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
            var sourceServerPath = "";
            if (isNetworkPath(source)) {
                sourceServerPath = "\\\\" + source.split("\\")[2];
            }

            if (destServerPath !== sourceServerPath) {  // ç•°ãªã‚‹ã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã®ã¿èªè¨¼
                batch += ":: ã‚³ãƒ”ãƒ¼å…ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼\r\n";
                batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ä¸­... >> %LOG_FILE%\r\n";
                batch += "echo ã‚³ãƒ”ãƒ¼å…ˆã‚µãƒ¼ãƒãƒ¼: " + destServerPath + " >> %LOG_FILE%\r\n";
                batch += "echo ãƒ¦ãƒ¼ã‚¶ãƒ¼: " + userPart + " >> %LOG_FILE%\r\n";
                batch += "\r\n";
                batch += ":: æ—¢å­˜ã®æ¥ç¶šã‚’åˆ‡æ–­\r\n";
                batch += "net use \"" + destServerPath + "\" /delete /y >nul 2>&1\r\n";
                batch += "\r\n";
                batch += ":: æ–°ã—ã„æ¥ç¶šã‚’ç¢ºç«‹\r\n";
                batch += "net use \"" + destServerPath + "\" " + password + " /user:\"" + userPart + "\" /persistent:no\r\n";
                batch += "if !errorlevel! neq 0 (\r\n";
                batch += "    echo [%date% %time%] ERROR: ã‚³ãƒ”ãƒ¼å…ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼ã«å¤±æ•— ^(ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: !errorlevel!^) >> %LOG_FILE%\r\n";
                batch += "    echo è©³ç´°: net use ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ >> %LOG_FILE%\r\n";
                batch += "    set ERROR_OCCURRED=1\r\n";
                batch += "    goto :CLEANUP\r\n";
                batch += ")\r\n";
                batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èªè¨¼æˆåŠŸ >> %LOG_FILE%\r\n";
                batch += "\r\n";
            } else {
                batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆã¯åŒã˜ã‚µãƒ¼ãƒãƒ¼ã®ãŸã‚èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ— >> %LOG_FILE%\r\n";
                batch += "\r\n";
            }
        }
    }

    // æ¥ç¶šç¢ºèªã¨Robocopyå®Ÿè¡Œ
    batch += ":: ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª\r\n";
    batch += "echo [%date% %time%] ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªä¸­... >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: ã‚³ãƒ”ãƒ¼å…ƒãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèª\r\n";
    batch += "if not exist \"" + source + "\" (\r\n";
    batch += "    echo [%date% %time%] ERROR: ã‚³ãƒ”ãƒ¼å…ƒãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: " + source + " >> %LOG_FILE%\r\n";
    batch += "    set ERROR_OCCURRED=1\r\n";
    batch += "    goto :CLEANUP\r\n";
    batch += ")\r\n";
    batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ƒãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªOK >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèªï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã‚’è©¦è¡Œï¼‰\r\n";
    batch += "if not exist \"" + dest + "\" (\r\n";
    batch += "    echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„ãŸã‚ä½œæˆã‚’è©¦è¡Œ: " + dest + " >> %LOG_FILE%\r\n";
    batch += "    mkdir \"" + dest + "\" 2>>%LOG_FILE%\r\n";
    batch += "    if !errorlevel! neq 0 (\r\n";
    batch += "        echo [%date% %time%] ERROR: ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã§ãã¾ã›ã‚“: " + dest + " >> %LOG_FILE%\r\n";
    batch += "        set ERROR_OCCURRED=1\r\n";
    batch += "        goto :CLEANUP\r\n";
    batch += "    )\r\n";
    batch += ")\r\n";
    batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªOK >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: Robocopyå®Ÿè¡Œ\r\n";
    batch += "echo [%date% %time%] Robocopyå®Ÿè¡Œé–‹å§‹ >> %LOG_FILE%\r\n";
    batch += "echo ã‚³ãƒãƒ³ãƒ‰: robocopy \"" + source + "\" \"" + dest + "\" " + options + " >> %LOG_FILE%\r\n";
    batch += "echo ---------------------------------------- >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: æ—¢å­˜ã®ä¸€æ™‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤\r\n";
    batch += "if exist %TEMP_LOG% del %TEMP_LOG%\r\n";
    batch += "\r\n";
    batch += ":: robocopyã‚’å®Ÿè¡Œï¼ˆä¸€æ™‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ï¼‰\r\n";
    batch += "robocopy \"" + source + "\" \"" + dest + "\" " + options + " > %TEMP_LOG% 2>&1\r\n";
    batch += "set ROBOCOPY_EXIT_CODE=!errorlevel!\r\n";
    batch += "\r\n";
    batch += ":: robocopyã®å‡ºåŠ›ã‚’ãƒ¡ã‚¤ãƒ³ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆ\r\n";
    batch += "if exist %TEMP_LOG% (\r\n";
    batch += "    type %TEMP_LOG% >> %LOG_FILE%\r\n";
    batch += "    del %TEMP_LOG%\r\n";
    batch += ") else (\r\n";
    batch += "    echo robocopyã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ >> %LOG_FILE%\r\n";
    batch += ")\r\n";
    batch += "\r\n";
    batch += "echo ---------------------------------------- >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: Robocopyçµæœåˆ¤å®šï¼ˆ0-7ã¯æ­£å¸¸ã€8ä»¥ä¸Šã¯ã‚¨ãƒ©ãƒ¼ï¼‰\r\n";
    batch += "if !ROBOCOPY_EXIT_CODE! LSS 8 (\r\n";
    batch += "    echo [%date% %time%] Robocopyå®Ÿè¡ŒæˆåŠŸ ^(æˆ»ã‚Šå€¤: !ROBOCOPY_EXIT_CODE!^) >> %LOG_FILE%\r\n";
    batch += "    set BACKUP_SUCCESS=1\r\n";
    batch += ") else (\r\n";
    batch += "    echo [%date% %time%] Robocopyå®Ÿè¡Œå¤±æ•— ^(æˆ»ã‚Šå€¤: !ROBOCOPY_EXIT_CODE!^) >> %LOG_FILE%\r\n";
    batch += "    set BACKUP_SUCCESS=0\r\n";
    batch += "    set ERROR_OCCURRED=1\r\n";
    batch += ")\r\n";
    batch += "\r\n";

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«å¯¾å¿œï¼‰
    if (document.getElementById('emailEnabled').checked) {
        var taskName = document.getElementById('taskName').value;
        var psScriptName = taskName + "_batch_mail.ps1";
        var psScriptPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)), psScriptName);

        batch += ":: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«èªè¨¼ï¼‰\r\n";
        batch += "echo [%date% %time%] ãƒ¡ãƒ¼ãƒ«é€ä¿¡æº–å‚™ä¸­... >> %LOG_FILE%\r\n";
        batch += "echo PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹: " + psScriptPath + " >> %LOG_FILE%\r\n";
        batch += "\r\n";
        batch += ":: PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å­˜åœ¨ç¢ºèª\r\n";
        batch += "if not exist \"" + psScriptPath + "\" (\r\n";
        batch += "    echo [%date% %time%] WARNING: PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ >> %LOG_FILE%\r\n";
        batch += "    echo ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: " + psScriptPath + " >> %LOG_FILE%\r\n";
        batch += "    echo ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: %CD% >> %LOG_FILE%\r\n";
        batch += "    echo ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ >> %LOG_FILE%\r\n";
        batch += "    goto :SKIP_MAIL\r\n";
        batch += ")\r\n";
        batch += "\r\n";
        batch += "echo [%date% %time%] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­... >> %LOG_FILE%\r\n";
        batch += ":: PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¸¡ã—ã¦å®Ÿè¡Œ\r\n";
        batch += "powershell -ExecutionPolicy Bypass -File \"" + psScriptPath + "\" !BACKUP_SUCCESS! %LOG_FILE% >> %LOG_FILE% 2>&1\r\n";
        batch += "if !errorlevel! neq 0 (\r\n";
        batch += "    echo [%date% %time%] WARNING: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•— >> %LOG_FILE%\r\n";
        batch += ") else (\r\n";
        batch += "    echo [%date% %time%] ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº† >> %LOG_FILE%\r\n";
        batch += ")\r\n";
        batch += "\r\n";
        batch += ":SKIP_MAIL\r\n";
        batch += "\r\n";
    }

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    batch += ":CLEANUP\r\n";
    batch += ":: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹\r\n";
    batch += "echo [%date% %time%] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹ >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤\r\n";
    batch += "if exist %TEMP_LOG% (\r\n";
    batch += "    del %TEMP_LOG%\r\n";
    batch += "    echo [%date% %time%] ä¸€æ™‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ >> %LOG_FILE%\r\n";
    batch += ")\r\n";
    batch += "\r\n";
    batch += ":: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šåˆ‡æ–­\r\n";

    // ã‚³ãƒ”ãƒ¼å…ƒã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­
    if (isNetworkPath(source) && document.getElementById('sourceUsername').value) {
        var serverPath = "\\\\" + source.split("\\")[2];
        batch += "net use \"" + serverPath + "\" /delete /y >nul 2>&1\r\n";
        batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ƒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šåˆ‡æ–­: " + serverPath + " >> %LOG_FILE%\r\n";
    }

    // ã‚³ãƒ”ãƒ¼å…ˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­
    if (isNetworkPath(dest) && document.getElementById('destUsername').value) {
        var destServerPath = "\\\\" + dest.split("\\")[2];
        // åŒã˜ã‚µãƒ¼ãƒãƒ¼ã§ãªã„å ´åˆã®ã¿åˆ‡æ–­
        var sourceServerPath = isNetworkPath(source) ? "\\\\" + source.split("\\")[2] : "";
        if (destServerPath !== sourceServerPath) {
            batch += "net use \"" + destServerPath + "\" /delete /y >nul 2>&1\r\n";
            batch += "echo [%date% %time%] ã‚³ãƒ”ãƒ¼å…ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šåˆ‡æ–­: " + destServerPath + " >> %LOG_FILE%\r\n";
        }
    }

    batch += "\r\n";
    batch += ":: çµ‚äº†å‡¦ç†\r\n";
    batch += "echo [%date% %time%] ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµ‚äº† ^(ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°: !ERROR_OCCURRED!^) >> %LOG_FILE%\r\n";
    batch += "echo =========================================== >> %LOG_FILE%\r\n";
    batch += "\r\n";
    batch += ":: çµ‚äº†ã‚³ãƒ¼ãƒ‰ã®è¨­å®š\r\n";
    batch += "if !ERROR_OCCURRED! equ 1 (\r\n";
    batch += "    exit /b 1\r\n";
    batch += ") else (\r\n";
    batch += "    exit /b !ROBOCOPY_EXIT_CODE!\r\n";
    batch += ")\r\n";

    return batch;
}

function padZero(num) {
    var n = parseInt(num, 10);
    return n < 10 ? "0" + n : "" + n;
}

// ======================================
// PowerShellãƒ¡ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
// ======================================

function generateMailScript() {
    var smtpServer = escapePowerShellString(document.getElementById('smtpServer').value.trim());
    var smtpPort = document.getElementById('smtpPort').value.trim();
    var senderEmail = escapePowerShellString(document.getElementById('senderEmail').value.trim());
    var senderPassword = escapePowerShellString(document.getElementById('senderPassword').value.trim());
    var recipientEmail = escapePowerShellString(document.getElementById('recipientEmail').value.trim());

    var connectionSecurity = document.getElementById('connectionSecurity').value;
    var authMethod = document.getElementById('authMethod').value;
    var useSSL = connectionSecurity === "SSL/TLS";
    var useSTARTTLS = connectionSecurity === "STARTTLS";

    var sourcePath = escapePowerShellString(document.getElementById('source').value);
    var destPath = escapePowerShellString(document.getElementById('dest').value);

    var ps1 = "# RCScheduler ãƒãƒƒãƒå®Ÿè¡Œç”¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡\r\n";
    ps1 += "param(\r\n";
    ps1 += "    [string]$BackupSuccess = \"0\",\r\n";
    ps1 += "    [string]$LogFilePath = \"\"\r\n";
    ps1 += ")\r\n\r\n";

    ps1 += "$ErrorActionPreference = \"Stop\"\r\n\r\n";

    ps1 += "# è¨­å®š\r\n";
    ps1 += "$SmtpServer = \"" + smtpServer + "\"\r\n";
    ps1 += "$SmtpPort = " + smtpPort + "\r\n";
    ps1 += "$SenderEmail = \"" + senderEmail + "\"\r\n";
    ps1 += "$SenderPassword = \"" + senderPassword + "\"\r\n";
    ps1 += "$RecipientEmail = \"" + recipientEmail + "\"\r\n";
    ps1 += "$UseSSL = " + (useSSL ? "$true" : "$false") + "\r\n";
    ps1 += "$UseSTARTTLS = " + (useSTARTTLS ? "$true" : "$false") + "\r\n";
    ps1 += "$AuthMethod = \"" + authMethod + "\"\r\n\r\n";

    ps1 += "# ä»¶åè¨­å®š\r\n";
    ps1 += "if ($BackupSuccess -eq \"1\") {\r\n";
    ps1 += "    $Subject = \"Robocopyãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµæœ - æˆåŠŸ\"\r\n";
    ps1 += "    $Result = \"æˆåŠŸ\"\r\n";
    ps1 += "} else {\r\n";
    ps1 += "    $Subject = \"Robocopyãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµæœ - å¤±æ•—\"\r\n";
    ps1 += "    $Result = \"å¤±æ•—\"\r\n";
    ps1 += "}\r\n\r\n";

    ps1 += "function ConvertTo-Base64($text) {\r\n";
    ps1 += "    $bytes = [System.Text.Encoding]::UTF8.GetBytes($text)\r\n";
    ps1 += "    return [System.Convert]::ToBase64String($bytes)\r\n";
    ps1 += "}\r\n\r\n";

    ps1 += "function Send-AuthCommand($writer, $reader, $authMethod, $username, $password) {\r\n";
    ps1 += "    switch ($authMethod) {\r\n";
    ps1 += "        \"CRAM-MD5\" {\r\n";
    ps1 += "            $writer.WriteLine(\"AUTH CRAM-MD5\")\r\n";
    ps1 += "            $writer.Flush()\r\n";
    ps1 += "            $response = $reader.ReadLine()\r\n";
    ps1 += "            \r\n";
    ps1 += "            if ($response.StartsWith(\"334\")) {\r\n";
    ps1 += "                $challenge = $response.Substring(4)\r\n";
    ps1 += "                $challengeBytes = [System.Convert]::FromBase64String($challenge)\r\n";
    ps1 += "                $challengeText = [System.Text.Encoding]::UTF8.GetString($challengeBytes)\r\n";
    ps1 += "                \r\n";
    ps1 += "                $hmac = New-Object System.Security.Cryptography.HMACMD5\r\n";
    ps1 += "                $hmac.Key = [System.Text.Encoding]::UTF8.GetBytes($password)\r\n";
    ps1 += "                $hash = $hmac.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($challengeText))\r\n";
    ps1 += "                $hashHex = [System.BitConverter]::ToString($hash) -replace \"-\", \"\"\r\n";
    ps1 += "                \r\n";
    ps1 += "                $cramResponse = \"$username \" + $hashHex.ToLower()\r\n";
    ps1 += "                $encodedResponse = ConvertTo-Base64 $cramResponse\r\n";
    ps1 += "                $writer.WriteLine($encodedResponse)\r\n";
    ps1 += "                $writer.Flush()\r\n";
    ps1 += "            }\r\n";
    ps1 += "        }\r\n";
    ps1 += "        \"LOGIN\" {\r\n";
    ps1 += "            $writer.WriteLine(\"AUTH LOGIN\")\r\n";
    ps1 += "            $writer.Flush()\r\n";
    ps1 += "            $response = $reader.ReadLine()\r\n";
    ps1 += "            if ($response.StartsWith(\"334\")) {\r\n";
    ps1 += "                $writer.WriteLine((ConvertTo-Base64 $username))\r\n";
    ps1 += "                $writer.Flush()\r\n";
    ps1 += "                $response = $reader.ReadLine()\r\n";
    ps1 += "                if ($response.StartsWith(\"334\")) {\r\n";
    ps1 += "                    $writer.WriteLine((ConvertTo-Base64 $password))\r\n";
    ps1 += "                    $writer.Flush()\r\n";
    ps1 += "                }\r\n";
    ps1 += "            }\r\n";
    ps1 += "        }\r\n";
    ps1 += "        \"PLAIN\" {\r\n";
    ps1 += "            $authString = ConvertTo-Base64(\"`0$username`0$password\")\r\n";
    ps1 += "            $writer.WriteLine(\"AUTH PLAIN $authString\")\r\n";
    ps1 += "            $writer.Flush()\r\n";
    ps1 += "        }\r\n";
    ps1 += "    }\r\n";
    ps1 += "    \r\n";
    ps1 += "    $response = $reader.ReadLine()\r\n";
    ps1 += "    return $response.StartsWith(\"235\")\r\n";
    ps1 += "}\r\n\r\n";

    ps1 += "try {\r\n";
    ps1 += "    # æ¥ç¶š\r\n";
    ps1 += "    $tcpClient = New-Object System.Net.Sockets.TcpClient\r\n";
    ps1 += "    $tcpClient.Connect($SmtpServer, $SmtpPort)\r\n";
    ps1 += "    $stream = $tcpClient.GetStream()\r\n";
    ps1 += "    \r\n";
    ps1 += "    # SSL/STARTTLSå‡¦ç†\r\n";
    ps1 += "    if ($UseSSL) {\r\n";
    ps1 += "        $sslStream = New-Object System.Net.Security.SslStream($stream)\r\n";
    ps1 += "        $sslStream.AuthenticateAsClient($SmtpServer)\r\n";
    ps1 += "        $stream = $sslStream\r\n";
    ps1 += "        Start-Sleep -Milliseconds 500\r\n";
    ps1 += "    }\r\n";
    ps1 += "    \r\n";
    ps1 += "    $reader = New-Object System.IO.StreamReader($stream)\r\n";
    ps1 += "    $writer = New-Object System.IO.StreamWriter($stream)\r\n";
    ps1 += "    \r\n";
    ps1 += "    # SMTPé€šä¿¡\r\n";
    ps1 += "    $response = $reader.ReadLine()  # 220å¿œç­”\r\n";
    ps1 += "    \r\n";
    ps1 += "    $writer.WriteLine(\"EHLO localhost\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    do { $response = $reader.ReadLine() } while ($response.StartsWith(\"250-\"))\r\n";
    ps1 += "    \r\n";
    ps1 += "    if ($UseSTARTTLS -and -not $UseSSL) {\r\n";
    ps1 += "        $writer.WriteLine(\"STARTTLS\")\r\n";
    ps1 += "        $writer.Flush()\r\n";
    ps1 += "        $response = $reader.ReadLine()\r\n";
    ps1 += "        if ($response.StartsWith(\"220\")) {\r\n";
    ps1 += "            $sslStream = New-Object System.Net.Security.SslStream($stream)\r\n";
    ps1 += "            $sslStream.AuthenticateAsClient($SmtpServer)\r\n";
    ps1 += "            $stream = $sslStream\r\n";
    ps1 += "            $reader = New-Object System.IO.StreamReader($stream)\r\n";
    ps1 += "            $writer = New-Object System.IO.StreamWriter($stream)\r\n";
    ps1 += "            \r\n";
    ps1 += "            $writer.WriteLine(\"EHLO localhost\")\r\n";
    ps1 += "            $writer.Flush()\r\n";
    ps1 += "            do { $response = $reader.ReadLine() } while ($response.StartsWith(\"250-\"))\r\n";
    ps1 += "        }\r\n";
    ps1 += "    }\r\n";
    ps1 += "    \r\n";
    ps1 += "    # èªè¨¼\r\n";
    ps1 += "    if (-not (Send-AuthCommand $writer $reader $AuthMethod $SenderEmail $SenderPassword)) {\r\n";
    ps1 += "        throw \"èªè¨¼å¤±æ•—\"\r\n";
    ps1 += "    }\r\n";
    ps1 += "    \r\n";
    ps1 += "    # ãƒ¡ãƒ¼ãƒ«é€ä¿¡\r\n";
    ps1 += "    $writer.WriteLine(\"MAIL FROM:<$SenderEmail>\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    $reader.ReadLine()\r\n";
    ps1 += "    \r\n";
    ps1 += "    $writer.WriteLine(\"RCPT TO:<$RecipientEmail>\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    $reader.ReadLine()\r\n";
    ps1 += "    \r\n";
    ps1 += "    $writer.WriteLine(\"DATA\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    $reader.ReadLine()\r\n";
    ps1 += "    \r\n";
    ps1 += "    # ãƒ¡ãƒ¼ãƒ«å†…å®¹\r\n";
    ps1 += "    $writer.WriteLine(\"From: $SenderEmail\")\r\n";
    ps1 += "    $writer.WriteLine(\"To: $RecipientEmail\")\r\n";
    ps1 += "    $writer.WriteLine(\"Subject: $Subject\")\r\n";
    ps1 += "    $writer.WriteLine(\"Date: $(Get-Date -Format 'r')\")\r\n";
    ps1 += "    $writer.WriteLine(\"Content-Type: text/plain; charset=utf-8\")\r\n";
    ps1 += "    $writer.WriteLine(\"\")\r\n";
    ps1 += "    $writer.WriteLine(\"Robocopyãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œçµæœã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚\")\r\n";
    ps1 += "    $writer.WriteLine(\"\")\r\n";
    ps1 += "    $writer.WriteLine(\"å®Ÿè¡Œæ—¥æ™‚: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\")\r\n";
    ps1 += "    $writer.WriteLine(\"çµæœ: $Result\")\r\n";
    ps1 += "    $writer.WriteLine(\"ã‚³ãƒ”ãƒ¼å…ƒ: " + sourcePath + "\")\r\n";
    ps1 += "    $writer.WriteLine(\"ã‚³ãƒ”ãƒ¼å…ˆ: " + destPath + "\")\r\n";
    ps1 += "    $writer.WriteLine(\"\")\r\n";
    ps1 += "    if ($LogFilePath -and (Test-Path $LogFilePath)) {\r\n";
    ps1 += "        $writer.WriteLine(\"ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $LogFilePath\")\r\n";
    ps1 += "        $writer.WriteLine(\"\")\r\n";
    ps1 += "        $writer.WriteLine(\"=== ãƒ­ã‚°å†…å®¹ï¼ˆå…¨æ–‡ï¼‰ ===\")\r\n";
    ps1 += "        $logLines = Get-Content $LogFilePath -ErrorAction SilentlyContinue\r\n";
    ps1 += "        if ($logLines) {\r\n";
    ps1 += "            foreach ($line in $logLines) {\r\n";
    ps1 += "                $writer.WriteLine($line)\r\n";
    ps1 += "            }\r\n";
    ps1 += "        } else {\r\n";
    ps1 += "            $writer.WriteLine(\"ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ\")\r\n";
    ps1 += "        }\r\n";
    ps1 += "    } else {\r\n";
    ps1 += "        $writer.WriteLine(\"ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $LogFilePath\")\r\n";
    ps1 += "    }\r\n";
    ps1 += "    $writer.WriteLine(\".\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    \r\n";
    ps1 += "    $response = $reader.ReadLine()\r\n";
    ps1 += "    if (-not $response.StartsWith(\"250\")) {\r\n";
    ps1 += "        throw \"é€ä¿¡å¤±æ•—: $response\"\r\n";
    ps1 += "    }\r\n";
    ps1 += "    \r\n";
    ps1 += "    $writer.WriteLine(\"QUIT\")\r\n";
    ps1 += "    $writer.Flush()\r\n";
    ps1 += "    \r\n";
    ps1 += "    Write-Output \"ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†\"\r\n";
    ps1 += "    exit 0\r\n";
    ps1 += "    \r\n";
    ps1 += "} catch {\r\n";
    ps1 += "    Write-Output \"ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)\"\r\n";
    ps1 += "    exit 1\r\n";
    ps1 += "} finally {\r\n";
    ps1 += "    if ($stream) { $stream.Close() }\r\n";
    ps1 += "    if ($tcpClient) { $tcpClient.Close() }\r\n";
    ps1 += "}\r\n";

    return ps1;
}

// ======================================
// ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©æ“ä½œ
// ======================================

function createScheduledTask() {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    var source = document.getElementById('source').value;
    var dest = document.getElementById('dest').value;
    var taskName = document.getElementById('taskName').value;

    if (!source || !dest) {
        alert("ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!taskName) {
        alert("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!isAdmin()) {
        alert("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
        return;
    }

    try {
        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™...");

        // è¨­å®šã‚’ä¿å­˜
        saveConfig();

        // ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ
        var batchContent = generateBatchScript();
        var batchPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)),
                                      taskName + ".bat");

        var file = fso.CreateTextFile(batchPath, true, false);
        file.Write(batchContent);
        file.Close();

        logMessage("ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: " + batchPath);

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ¡ãƒ¼ãƒ«æœ‰åŠ¹æ™‚ï¼‰
        if (document.getElementById('emailEnabled').checked) {
            var mailScript = generateMailScript();
            var mailScriptPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)),
                                               taskName + "_mail.ps1");

            var mailFile = fso.CreateTextFile(mailScriptPath, true, true); // UTF-8 BOM
            mailFile.Write(mailScript);
            mailFile.Close();

            logMessage("ãƒ¡ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: " + mailScriptPath);
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ä½œæˆã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
        var frequency = document.querySelector('input[name="frequency"]:checked').value;
        var hour = document.getElementById('hour').value;
        var minute = document.getElementById('minute').value;

        // æ™‚åˆ»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!hour || !minute) {
            alert("å®Ÿè¡Œæ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // æ•°å€¤ã«å¤‰æ›
        hour = parseInt(hour, 10);
        minute = parseInt(minute, 10);

        // ç¯„å›²ãƒã‚§ãƒƒã‚¯
        if (isNaN(hour) || hour < 0 || hour > 23) {
            alert("æ™‚é–“ã¯0ï½23ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        if (isNaN(minute) || minute < 0 || minute > 59) {
            alert("åˆ†ã¯0ï½59ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        var startTime = padZero(hour) + ":" + padZero(minute);

        var scheduleType = "";
        if (frequency === "DAILY") {
            scheduleType = "/SC DAILY";
        } else {
            var weekdays = getSelectedWeekdays();
            if (!weekdays) {
                alert("æ¯é€±å®Ÿè¡Œã®å ´åˆã¯ã€å®Ÿè¡Œæ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            scheduleType = "/SC WEEKLY /D " + weekdays;
        }

        var cmd = 'schtasks /CREATE /TN "' + taskName + '" ' +
                  '/TR "\\"' + batchPath + '\\"" ' +
                  scheduleType + ' ' +
                  '/ST ' + startTime + ' ' +
                  '/RU "SYSTEM" ' +
                  '/RL HIGHEST /F';

        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œä¸­...");
        logMessage("å®Ÿè¡Œæ™‚åˆ»: " + startTime);
        logMessage("ã‚³ãƒãƒ³ãƒ‰: " + cmd);

        // HTAã§ã¯WScript.SleepãŒä½¿ãˆãªã„ãŸã‚ã€shell.Runã§åŒæœŸå®Ÿè¡Œ
        // å‡ºåŠ›ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆé–¢æ•°ã”ã¨ã«ç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨ï¼‰
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_create_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_create_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true); // ç¬¬3å¼•æ•°true = å®Œäº†ã‚’å¾…ã¤

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        var error = "";

        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        if (exitCode === 0) {
            logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ", "success");
            logMessage("ã‚¿ã‚¹ã‚¯å: " + taskName);
            logMessage("æ¬¡å›å®Ÿè¡Œæ™‚åˆ»: " + startTime);
            alert("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¸ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nã‚¿ã‚¹ã‚¯å: " + taskName + "\næ¬¡å›å®Ÿè¡Œæ™‚åˆ»: " + startTime);
            updateTaskStatus();
        } else {
            logMessage("ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error, "error");
            alert("ã‚¿ã‚¹ã‚¯ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + error);
        }

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
}

function deleteScheduledTask() {
    var taskName = document.getElementById('taskName').value;

    if (!taskName) {
        alert("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!isAdmin()) {
        alert("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
        return;
    }

    if (!confirm("ã‚¿ã‚¹ã‚¯ã€Œ" + taskName + "ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        return;
    }

    try {
        logMessage("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™...");

        var cmd = 'schtasks /DELETE /TN "' + taskName + '" /F';

        // HTAã§ã¯WScript.SleepãŒä½¿ãˆãªã„ãŸã‚ã€shell.Runã§åŒæœŸå®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_delete_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_delete_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        var error = "";

        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        if (exitCode === 0) {
            logMessage("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");

            // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤
            var batchPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)),
                                          taskName + ".bat");
            if (fso.FileExists(batchPath)) {
                fso.DeleteFile(batchPath);
                logMessage("ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: " + batchPath);
            }

            // ãƒ¡ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å‰Šé™¤
            var mailScriptPath = fso.BuildPath(fso.GetParentFolderName(location.pathname.substring(1)),
                                               taskName + "_mail.ps1");
            if (fso.FileExists(mailScriptPath)) {
                fso.DeleteFile(mailScriptPath);
                logMessage("ãƒ¡ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ: " + mailScriptPath);
            }

            alert("ã‚¿ã‚¹ã‚¯ã€Œ" + taskName + "ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            updateTaskStatus();
        } else {
            logMessage("ã‚¿ã‚¹ã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + error, "error");
            alert("ã‚¿ã‚¹ã‚¯å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + error);
        }

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ã‚¿ã‚¹ã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
}

function updateTaskStatus() {
    var taskName = document.getElementById('taskName').value;

    if (!taskName) {
        document.getElementById('taskStatus').innerText = "ã‚¿ã‚¹ã‚¯åãŒæœªè¨­å®š";
        return;
    }

    try {
        var cmd = 'schtasks /QUERY /TN "' + taskName + '" /FO LIST /V';

        // HTAã§ã¯WScript.SleepãŒä½¿ãˆãªã„ãŸã‚ã€shell.Runã§åŒæœŸå®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_status_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_status_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        var error = "";

        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        if (exitCode === 0) {
            // ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹
            // æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã‚’æŠ½å‡º
            var lines = output.split("\n");
            var nextRunTime = "ä¸æ˜";

            for (var i = 0; i < lines.length; i++) {
                if (lines[i].indexOf("æ¬¡å›ã®å®Ÿè¡Œæ™‚åˆ»") !== -1 || lines[i].indexOf("Next Run Time") !== -1) {
                    nextRunTime = lines[i].split(":")[1];
                    if (nextRunTime) {
                        nextRunTime = nextRunTime.trim();
                    }
                    break;
                }
            }

            document.getElementById('taskStatus').innerText = "ç™»éŒ²æ¸ˆã¿ - æ¬¡å›å®Ÿè¡Œ: " + nextRunTime;
            logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ç™»éŒ²æ¸ˆã¿");
        } else {
            document.getElementById('taskStatus').innerText = "æœªç™»éŒ²";
            logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ: æœªç™»éŒ²");
        }

    } catch(e) {
        document.getElementById('taskStatus').innerText = "ç¢ºèªã‚¨ãƒ©ãƒ¼";
        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

// ======================================
// ã‚¿ã‚¹ã‚¯å±¥æ­´è¨­å®šæ©Ÿèƒ½
// ======================================

function enableTaskHistory() {
    if (!isAdmin()) {
        alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®æœ‰åŠ¹åŒ–ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
        return { success: false, message: "ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™" };
    }

    try {
        logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã¾ã™...");

        var cmd = 'wevtutil set-log Microsoft-Windows-TaskScheduler/Operational /enabled:true';

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var error = "";
        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (fso.FileExists(tempOutput)) {
            fso.DeleteFile(tempOutput);
        }

        if (exitCode === 0) {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ", "success");
            document.getElementById('taskHistoryStatus').innerText = "æœ‰åŠ¹";
            alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚");
            return { success: true, message: "æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ" };
        } else {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error, "error");
            alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + error);
            return { success: false, message: error };
        }

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´æœ‰åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ã‚¿ã‚¹ã‚¯å±¥æ­´æœ‰åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
        return { success: false, message: e.message };
    }
}

function disableTaskHistory() {
    if (!isAdmin()) {
        alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®ç„¡åŠ¹åŒ–ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚");
        return { success: false, message: "ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™" };
    }

    if (!confirm("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€»æ—¢å­˜ã®å±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€æ–°ã—ã„å±¥æ­´ã¯è¨˜éŒ²ã•ã‚Œãªããªã‚Šã¾ã™ã€‚")) {
        return { success: false, message: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ" };
    }

    try {
        logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™...");

        var cmd = 'wevtutil set-log Microsoft-Windows-TaskScheduler/Operational /enabled:false';

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var error = "";
        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (fso.FileExists(tempOutput)) {
            fso.DeleteFile(tempOutput);
        }

        if (exitCode === 0) {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ", "success");
            document.getElementById('taskHistoryStatus').innerText = "ç„¡åŠ¹";
            alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚");
            return { success: true, message: "ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ" };
        } else {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®ç„¡åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error, "error");
            alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®ç„¡åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + error);
            return { success: false, message: error };
        }

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
        return { success: false, message: e.message };
    }
}

function getTaskHistoryStatus(silent) {
    // silent = trueã®å ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„ï¼ˆèµ·å‹•æ™‚ç”¨ï¼‰
    silent = silent || false;

    try {
        if (!silent) {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...");
        }

        var cmd = 'wevtutil get-log Microsoft-Windows-TaskScheduler/Operational';

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_status.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_history_status_error.txt");

        var cmdFull = 'cmd.exe /c ' + cmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        // ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var error = "";
        if (fso.FileExists(tempError)) {
            var errFileObj = fso.GetFile(tempError);
            if (errFileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        if (exitCode === 0 && output) {
            // å‡ºåŠ›ã‹ã‚‰ enabled çŠ¶æ…‹ã‚’è§£æ
            var lines = output.split("\n");
            var enabled = false;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                // "enabled: true" ã¾ãŸã¯ "enabled: false" ã®å½¢å¼ã‚’æ¢ã™
                if (line.toLowerCase().indexOf("enabled:") !== -1) {
                    if (line.toLowerCase().indexOf("true") !== -1) {
                        enabled = true;
                    }
                    break;
                }
            }

            var statusText = enabled ? "æœ‰åŠ¹" : "ç„¡åŠ¹";
            document.getElementById('taskHistoryStatus').innerText = statusText;

            if (!silent) {
                logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹: " + statusText, "success");
                alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹: " + statusText);
            }

            return { enabled: enabled, message: statusText };
        } else {
            document.getElementById('taskHistoryStatus').innerText = "ç¢ºèªã‚¨ãƒ©ãƒ¼";

            if (!silent) {
                logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: " + error, "error");
                alert("ã‚¿ã‚¹ã‚¯å±¥æ­´ã®è¨­å®šçŠ¶æ…‹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + error);
            }

            return { enabled: null, message: error };
        }

    } catch(e) {
        document.getElementById('taskHistoryStatus').innerText = "ç¢ºèªã‚¨ãƒ©ãƒ¼";

        if (!silent) {
            logMessage("ã‚¿ã‚¹ã‚¯å±¥æ­´è¨­å®šçŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: " + e.message, "error");
            alert("ã‚¿ã‚¹ã‚¯å±¥æ­´è¨­å®šçŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: " + e.message);
        }

        return { enabled: null, message: e.message };
    }
}

// ======================================
// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ
// ======================================

function testNetworkConnection(pathType) {
    var path, username, password, domain;

    if (pathType === "source") {
        path = document.getElementById('source').value;
        username = document.getElementById('sourceUsername').value;
        password = document.getElementById('sourcePassword').value;
        domain = document.getElementById('sourceDomain').value;
    } else {
        path = document.getElementById('dest').value;
        username = document.getElementById('destUsername').value;
        password = document.getElementById('destPassword').value;
        domain = document.getElementById('destDomain').value;
    }

    if (!isNetworkPath(path)) {
        alert("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    if (!username) {
        alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    try {
        logMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™...");

        var serverPath = "\\\\" + path.split("\\")[2];

        // æ—¢å­˜ã®æ¥ç¶šã‚’åˆ‡æ–­
        var disconnectCmd = 'net use "' + serverPath + '" /delete /y';
        shell.Run("cmd.exe /c " + disconnectCmd, 0, true);

        // èªè¨¼æƒ…å ±ã‚’æ§‹ç¯‰
        var userPart = domain ? domain + "\\" + username : username;

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        var connectCmd = 'net use "' + serverPath + '" "' + password + '" /user:"' + userPart + '"';
        var result = shell.Run("cmd.exe /c " + connectCmd, 0, true);

        if (result === 0) {
            alert(pathType + "ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸã€‚");
            logMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ: " + serverPath, "success");

            // ãƒ†ã‚¹ãƒˆå¾Œã¯åˆ‡æ–­
            shell.Run("cmd.exe /c " + disconnectCmd, 0, true);
        } else {
            alert(pathType + "ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            logMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: " + serverPath, "error");
        }

    } catch(e) {
        alert("æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n" + e.message);
        logMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: " + e.message, "error");
    }
}

// ======================================
// SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆ
// ======================================

function testSmtpConnection() {
    var smtpServer = document.getElementById('smtpServer').value.trim();
    var smtpPort = document.getElementById('smtpPort').value.trim();

    if (!smtpServer) {
        alert("SMTPã‚µãƒ¼ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!smtpPort) {
        alert("ãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // ãƒãƒ¼ãƒˆç•ªå·ã®æ¤œè¨¼
    var portNum = parseInt(smtpPort, 10);
    if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
        alert("æœ‰åŠ¹ãªãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1-65535ï¼‰");
        return;
    }

    try {
        logMessage("SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹: " + smtpServer + ":" + smtpPort);

        // æ¥ç¶šã®ä¿è­·è¨­å®šã‚’å–å¾—
        var connectionSecurity = document.getElementById('connectionSecurity').value;
        var useSSL = connectionSecurity === "SSL/TLS";

        // PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã§SMTPæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆ
        var psScript = "# SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ç‰ˆï¼‰\r\n";
        psScript += "$ErrorActionPreference = \"Stop\"\r\n\r\n";

        psScript += "$SmtpServer = \"" + escapePowerShellString(smtpServer) + "\"\r\n";
        psScript += "$SmtpPort = " + smtpPort + "\r\n";
        psScript += "$UseSSL = " + (useSSL ? "$true" : "$false") + "\r\n";
        psScript += "$ConnectionSecurity = \"" + connectionSecurity + "\"\r\n\r\n";

        psScript += "Write-Output \"SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹: $SmtpServer`:$SmtpPort\"\r\n";
        psScript += "Write-Output \"æ¥ç¶šã®ä¿è­·: $ConnectionSecurity\"\r\n\r\n";

        psScript += "try {\r\n";
        psScript += "    # TCPæ¥ç¶šãƒ†ã‚¹ãƒˆ\r\n";
        psScript += "    $tcpTest = Test-NetConnection -ComputerName $SmtpServer -Port $SmtpPort -WarningAction SilentlyContinue\r\n";
        psScript += "    \r\n";
        psScript += "    if ($tcpTest.TcpTestSucceeded) {\r\n";
        psScript += "        Write-Output \"TCPæ¥ç¶šæˆåŠŸ\"\r\n";
        psScript += "        \r\n";
        psScript += "        # SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆ\r\n";
        psScript += "        $tcpClient = New-Object System.Net.Sockets.TcpClient\r\n";
        psScript += "        $tcpClient.ReceiveTimeout = 10000\r\n";
        psScript += "        $tcpClient.SendTimeout = 10000\r\n";
        psScript += "        $tcpClient.Connect($SmtpServer, $SmtpPort)\r\n";
        psScript += "        \r\n";
        psScript += "        if ($tcpClient.Connected) {\r\n";
        psScript += "            $stream = $tcpClient.GetStream()\r\n";
        psScript += "            \r\n";
        psScript += "            # SSL/TLSå‡¦ç†\r\n";
        psScript += "            if ($UseSSL) {\r\n";
        psScript += "                Write-Output \"SSL/TLSæš—å·åŒ–é–‹å§‹...\"\r\n";
        psScript += "                $sslStream = New-Object System.Net.Security.SslStream($stream)\r\n";
        psScript += "                $sslStream.AuthenticateAsClient($SmtpServer)\r\n";
        psScript += "                $stream = $sslStream\r\n";
        psScript += "            }\r\n";
        psScript += "            \r\n";
        psScript += "            $reader = New-Object System.IO.StreamReader($stream)\r\n";
        psScript += "            $writer = New-Object System.IO.StreamWriter($stream)\r\n";
        psScript += "            \r\n";
        psScript += "            # SMTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®åˆæœŸãƒ¬ã‚¹ãƒãƒ³ã‚¹\r\n";
        psScript += "            $response = $reader.ReadLine()\r\n";
        psScript += "            Write-Output \"SMTPã‚µãƒ¼ãƒãƒ¼å¿œç­”: $response\"\r\n";
        psScript += "            \r\n";
        psScript += "            # STARTTLSç¢ºèª\r\n";
        psScript += "            if ($ConnectionSecurity -eq \"STARTTLS\" -and -not $UseSSL) {\r\n";
        psScript += "                Write-Output \"EHLOé€ä¿¡ï¼ˆSTARTTLSç¢ºèªç”¨ï¼‰...\"\r\n";
        psScript += "                $writer.WriteLine(\"EHLO localhost\")\r\n";
        psScript += "                $writer.Flush()\r\n";
        psScript += "                \r\n";
        psScript += "                do {\r\n";
        psScript += "                    $response = $reader.ReadLine()\r\n";
        psScript += "                    Write-Output \"EHLOå¿œç­”: $response\"\r\n";
        psScript += "                    if ($response -match \"STARTTLS\") {\r\n";
        psScript += "                        Write-Output \"STARTTLSå¯¾å¿œç¢ºèª\"\r\n";
        psScript += "                    }\r\n";
        psScript += "                } while ($response.StartsWith(\"250-\"))\r\n";
        psScript += "            }\r\n";
        psScript += "            \r\n";
        psScript += "            # QUITã§çµ‚äº†\r\n";
        psScript += "            $writer.WriteLine(\"QUIT\")\r\n";
        psScript += "            $writer.Flush()\r\n";
        psScript += "            \r\n";
        psScript += "            $stream.Close()\r\n";
        psScript += "            $tcpClient.Close()\r\n";
        psScript += "            \r\n";
        psScript += "            Write-Output \"SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ\"\r\n";
        psScript += "            exit 0\r\n";
        psScript += "        }\r\n";
        psScript += "    } else {\r\n";
        psScript += "        Write-Output \"TCPæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ\"\r\n";
        psScript += "        exit 1\r\n";
        psScript += "    }\r\n";
        psScript += "} catch {\r\n";
        psScript += "    Write-Output \"æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)\"\r\n";
        psScript += "    exit 1\r\n";
        psScript += "}\r\n";

        // ä¸€æ™‚çš„ãªPowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        var tempPsPath = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_smtp_test.ps1");
        var psFile = fso.CreateTextFile(tempPsPath, true, false); // SJIS
        psFile.Write(psScript);
        psFile.Close();

        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_smtp_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_smtp_error.txt");

        // PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        var cmdFull = 'powershell.exe -ExecutionPolicy Bypass -File "' + tempPsPath + '" > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        var error = "";

        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        // ä¸€æ™‚PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤
        if (fso.FileExists(tempPsPath)) {
            fso.DeleteFile(tempPsPath);
        }

        // çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        if (output) {
            var lines = output.split("\n");
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    logMessage("  " + lines[i].trim());
                }
            }
        }

        if (error) {
            var lines = error.split("\n");
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    logMessage("  ERROR: " + lines[i].trim(), "error");
                }
            }
        }

        if (exitCode === 0) {
            logMessage("SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ", "success");
            alert("SMTPã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸã€‚\n\n" +
                  "ã‚µãƒ¼ãƒãƒ¼: " + smtpServer + "\n" +
                  "ãƒãƒ¼ãƒˆ: " + smtpPort + "\n" +
                  "æ¥ç¶šã®ä¿è­·: " + connectionSecurity);
        } else {
            logMessage("SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—", "error");
            alert("SMTPã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

    } catch(e) {
        logMessage("SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("SMTPæ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n" + e.message);
    }
}

// ======================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆé€ä¿¡
// ======================================

function sendTestMail() {
    var smtpServer = document.getElementById('smtpServer').value.trim();
    var smtpPort = document.getElementById('smtpPort').value.trim();
    var senderEmail = document.getElementById('senderEmail').value.trim();
    var senderPassword = document.getElementById('senderPassword').value.trim();
    var recipientEmail = document.getElementById('recipientEmail').value.trim();

    // å…¥åŠ›æ¤œè¨¼
    if (!smtpServer) {
        alert("SMTPã‚µãƒ¼ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!smtpPort) {
        alert("ãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!senderEmail) {
        alert("é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!senderPassword) {
        alert("é€ä¿¡è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (!recipientEmail) {
        alert("å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // ãƒãƒ¼ãƒˆç•ªå·ã®æ¤œè¨¼
    var portNum = parseInt(smtpPort, 10);
    if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
        alert("æœ‰åŠ¹ãªãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1-65535ï¼‰");
        return;
    }

    if (!confirm("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\né€ä¿¡å…ˆ: " + recipientEmail)) {
        return;
    }

    try {
        logMessage("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...");

        // è¨­å®šå€¤ã‚’å–å¾—
        var connectionSecurity = document.getElementById('connectionSecurity').value;
        var authMethod = document.getElementById('authMethod').value;
        var useSSL = connectionSecurity === "SSL/TLS";
        var useSTARTTLS = connectionSecurity === "STARTTLS";

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        var now = new Date();
        var dateTimeStr = now.getFullYear() + "å¹´" +
                          (now.getMonth() + 1) + "æœˆ" +
                          now.getDate() + "æ—¥ " +
                          now.getHours() + ":" +
                          ("0" + now.getMinutes()).slice(-2) + ":" +
                          ("0" + now.getSeconds()).slice(-2);

        // ãƒ›ã‚¹ãƒˆåã‚’å–å¾—
        var hostName = shell.ExpandEnvironmentStrings("%COMPUTERNAME%");

        // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ç”¨PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ
        var psScript = "# RCScheduler ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡\r\n";
        psScript += "$ErrorActionPreference = \"Stop\"\r\n\r\n";

        psScript += "# è¨­å®š\r\n";
        psScript += "$SmtpServer = \"" + escapePowerShellString(smtpServer) + "\"\r\n";
        psScript += "$SmtpPort = " + smtpPort + "\r\n";
        psScript += "$SenderEmail = \"" + escapePowerShellString(senderEmail) + "\"\r\n";
        psScript += "$SenderPassword = \"" + escapePowerShellString(senderPassword) + "\"\r\n";
        psScript += "$RecipientEmail = \"" + escapePowerShellString(recipientEmail) + "\"\r\n";
        psScript += "$UseSSL = " + (useSSL ? "$true" : "$false") + "\r\n";
        psScript += "$UseSTARTTLS = " + (useSTARTTLS ? "$true" : "$false") + "\r\n";
        psScript += "$AuthMethod = \"" + authMethod + "\"\r\n\r\n";

        psScript += "# ãƒ¡ãƒ¼ãƒ«å†…å®¹\r\n";
        psScript += "$Subject = \"[ãƒ†ã‚¹ãƒˆ] RCScheduler ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ\"\r\n";
        psScript += "$Body = @\"\r\n";
        psScript += "RCScheduler ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ\r\n";
        psScript += "========================================\r\n\r\n";
        psScript += "é€ä¿¡æ—¥æ™‚: " + dateTimeStr + "\r\n";
        psScript += "å®Ÿè¡Œãƒ›ã‚¹ãƒˆ: " + hostName + "\r\n\r\n";
        psScript += "SMTPè¨­å®šæƒ…å ±:\r\n";
        psScript += "- SMTPã‚µãƒ¼ãƒãƒ¼: " + smtpServer + "\r\n";
        psScript += "- ãƒãƒ¼ãƒˆç•ªå·: " + smtpPort + "\r\n";
        psScript += "- æ¥ç¶šã®ä¿è­·: " + connectionSecurity + "\r\n";
        psScript += "- èªè¨¼æ–¹å¼: " + authMethod + "\r\n";
        psScript += "- é€ä¿¡å…ƒ: " + senderEmail + "\r\n";
        psScript += "- å®›å…ˆ: " + recipientEmail + "\r\n\r\n";
        psScript += "ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ RCScheduler ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚\r\n";
        psScript += "æ­£å¸¸ã«å—ä¿¡ã§ãã¦ã„ã‚Œã°ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™ã€‚\r\n";
        psScript += "\"@\r\n\r\n";

        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é–¢æ•°
        psScript += "function ConvertTo-Base64($text) {\r\n";
        psScript += "    $bytes = [System.Text.Encoding]::UTF8.GetBytes($text)\r\n";
        psScript += "    return [System.Convert]::ToBase64String($bytes)\r\n";
        psScript += "}\r\n\r\n";

        // èªè¨¼ã‚³ãƒãƒ³ãƒ‰é€ä¿¡é–¢æ•°ï¼ˆgenerateMailScripté–¢æ•°ã‹ã‚‰å¼•ç”¨ï¼‰
        psScript += "function Send-AuthCommand($writer, $reader, $authMethod, $username, $password) {\r\n";
        psScript += "    switch ($authMethod) {\r\n";
        psScript += "        \"CRAM-MD5\" {\r\n";
        psScript += "            $writer.WriteLine(\"AUTH CRAM-MD5\")\r\n";
        psScript += "            $writer.Flush()\r\n";
        psScript += "            $response = $reader.ReadLine()\r\n";
        psScript += "            \r\n";
        psScript += "            if ($response.StartsWith(\"334\")) {\r\n";
        psScript += "                $challenge = $response.Substring(4)\r\n";
        psScript += "                $challengeBytes = [System.Convert]::FromBase64String($challenge)\r\n";
        psScript += "                $challengeText = [System.Text.Encoding]::UTF8.GetString($challengeBytes)\r\n";
        psScript += "                \r\n";
        psScript += "                $hmac = New-Object System.Security.Cryptography.HMACMD5\r\n";
        psScript += "                $hmac.Key = [System.Text.Encoding]::UTF8.GetBytes($password)\r\n";
        psScript += "                $hash = $hmac.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($challengeText))\r\n";
        psScript += "                $hashHex = [System.BitConverter]::ToString($hash) -replace \"-\", \"\"\r\n";
        psScript += "                \r\n";
        psScript += "                $cramResponse = \"$username \" + $hashHex.ToLower()\r\n";
        psScript += "                $encodedResponse = ConvertTo-Base64 $cramResponse\r\n";
        psScript += "                $writer.WriteLine($encodedResponse)\r\n";
        psScript += "                $writer.Flush()\r\n";
        psScript += "            }\r\n";
        psScript += "        }\r\n";
        psScript += "        \"LOGIN\" {\r\n";
        psScript += "            $writer.WriteLine(\"AUTH LOGIN\")\r\n";
        psScript += "            $writer.Flush()\r\n";
        psScript += "            $response = $reader.ReadLine()\r\n";
        psScript += "            if ($response.StartsWith(\"334\")) {\r\n";
        psScript += "                $writer.WriteLine((ConvertTo-Base64 $username))\r\n";
        psScript += "                $writer.Flush()\r\n";
        psScript += "                $response = $reader.ReadLine()\r\n";
        psScript += "                if ($response.StartsWith(\"334\")) {\r\n";
        psScript += "                    $writer.WriteLine((ConvertTo-Base64 $password))\r\n";
        psScript += "                    $writer.Flush()\r\n";
        psScript += "                }\r\n";
        psScript += "            }\r\n";
        psScript += "        }\r\n";
        psScript += "        \"PLAIN\" {\r\n";
        psScript += "            $plainAuth = \"`0\" + $username + \"`0\" + $password\r\n";
        psScript += "            $encodedAuth = ConvertTo-Base64 $plainAuth\r\n";
        psScript += "            $writer.WriteLine(\"AUTH PLAIN $encodedAuth\")\r\n";
        psScript += "            $writer.Flush()\r\n";
        psScript += "        }\r\n";
        psScript += "    }\r\n";
        psScript += "}\r\n\r\n";

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†
        psScript += "try {\r\n";
        psScript += "    Write-Output \"ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹...\"\r\n";
        psScript += "    \r\n";
        psScript += "    # TCPæ¥ç¶š\r\n";
        psScript += "    $tcpClient = New-Object System.Net.Sockets.TcpClient\r\n";
        psScript += "    $tcpClient.ReceiveTimeout = 30000\r\n";
        psScript += "    $tcpClient.SendTimeout = 30000\r\n";
        psScript += "    \r\n";
        psScript += "    if ($UseSSL) {\r\n";
        psScript += "        Write-Output \"SSL/TLSæ¥ç¶šã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...\"\r\n";
        psScript += "        $tcpClient.Connect($SmtpServer, $SmtpPort)\r\n";
        psScript += "        $sslStream = New-Object System.Net.Security.SslStream($tcpClient.GetStream(), $false)\r\n";
        psScript += "        $sslStream.AuthenticateAsClient($SmtpServer)\r\n";
        psScript += "        $stream = $sslStream\r\n";
        psScript += "    } else {\r\n";
        psScript += "        Write-Output \"å¹³æ–‡æ¥ç¶šã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...\"\r\n";
        psScript += "        $tcpClient.Connect($SmtpServer, $SmtpPort)\r\n";
        psScript += "        $stream = $tcpClient.GetStream()\r\n";
        psScript += "    }\r\n";
        psScript += "    \r\n";
        psScript += "    $reader = New-Object System.IO.StreamReader($stream)\r\n";
        psScript += "    $writer = New-Object System.IO.StreamWriter($stream)\r\n";
        psScript += "    $writer.AutoFlush = $true\r\n";
        psScript += "    \r\n";
        psScript += "    # ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã‚’å¾…ã¤\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"ã‚µãƒ¼ãƒãƒ¼å¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    # EHLO\r\n";
        psScript += "    $writer.WriteLine(\"EHLO localhost\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"EHLOå¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    # è¿½åŠ ã®å¿œç­”ã‚’èª­ã¿å–ã‚‹\r\n";
        psScript += "    while ($response -match \"^250-\") {\r\n";
        psScript += "        $response = $reader.ReadLine()\r\n";
        psScript += "    }\r\n";
        psScript += "    \r\n";
        psScript += "    # STARTTLSå‡¦ç†\r\n";
        psScript += "    if ($UseSTARTTLS) {\r\n";
        psScript += "        Write-Output \"STARTTLSé–‹å§‹...\"\r\n";
        psScript += "        $writer.WriteLine(\"STARTTLS\")\r\n";
        psScript += "        $response = $reader.ReadLine()\r\n";
        psScript += "        Write-Output \"STARTTLSå¿œç­”: $response\"\r\n";
        psScript += "        \r\n";
        psScript += "        if ($response.StartsWith(\"220\")) {\r\n";
        psScript += "            $sslStream = New-Object System.Net.Security.SslStream($stream, $false)\r\n";
        psScript += "            $sslStream.AuthenticateAsClient($SmtpServer)\r\n";
        psScript += "            $stream = $sslStream\r\n";
        psScript += "            $reader = New-Object System.IO.StreamReader($stream)\r\n";
        psScript += "            $writer = New-Object System.IO.StreamWriter($stream)\r\n";
        psScript += "            $writer.AutoFlush = $true\r\n";
        psScript += "            \r\n";
        psScript += "            # STARTTLSå¾Œã«å†åº¦EHLO\r\n";
        psScript += "            $writer.WriteLine(\"EHLO localhost\")\r\n";
        psScript += "            $response = $reader.ReadLine()\r\n";
        psScript += "            while ($response -match \"^250-\") {\r\n";
        psScript += "                $response = $reader.ReadLine()\r\n";
        psScript += "            }\r\n";
        psScript += "        }\r\n";
        psScript += "    }\r\n";
        psScript += "    \r\n";
        psScript += "    # èªè¨¼\r\n";
        psScript += "    Write-Output \"èªè¨¼ä¸­ ($AuthMethod)...\"\r\n";
        psScript += "    Send-AuthCommand $writer $reader $AuthMethod $SenderEmail $SenderPassword\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"èªè¨¼å¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    if (-not $response.StartsWith(\"235\")) {\r\n";
        psScript += "        throw \"èªè¨¼å¤±æ•—: $response\"\r\n";
        psScript += "    }\r\n";
        psScript += "    \r\n";
        psScript += "    # MAIL FROM\r\n";
        psScript += "    $writer.WriteLine(\"MAIL FROM:<$SenderEmail>\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"MAIL FROMå¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    # RCPT TO\r\n";
        psScript += "    $writer.WriteLine(\"RCPT TO:<$RecipientEmail>\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"RCPT TOå¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    # DATA\r\n";
        psScript += "    $writer.WriteLine(\"DATA\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"DATAå¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    # ãƒ¡ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æœ¬æ–‡\r\n";
        psScript += "    $writer.WriteLine(\"From: <$SenderEmail>\")\r\n";
        psScript += "    $writer.WriteLine(\"To: <$RecipientEmail>\")\r\n";
        psScript += "    $writer.WriteLine(\"Subject: =?UTF-8?B?\" + (ConvertTo-Base64 $Subject) + \"?=\")\r\n";
        psScript += "    $writer.WriteLine(\"Content-Type: text/plain; charset=UTF-8\")\r\n";
        psScript += "    $writer.WriteLine(\"Content-Transfer-Encoding: base64\")\r\n";
        psScript += "    $writer.WriteLine(\"\")\r\n";
        psScript += "    \r\n";
        psScript += "    # æœ¬æ–‡ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰\r\n";
        psScript += "    $bodyBytes = [System.Text.Encoding]::UTF8.GetBytes($Body)\r\n";
        psScript += "    $bodyBase64 = [System.Convert]::ToBase64String($bodyBytes)\r\n";
        psScript += "    $writer.WriteLine($bodyBase64)\r\n";
        psScript += "    $writer.WriteLine(\".\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    Write-Output \"é€ä¿¡å¿œç­”: $response\"\r\n";
        psScript += "    \r\n";
        psScript += "    if ($response.StartsWith(\"250\")) {\r\n";
        psScript += "        Write-Output \"ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ\"\r\n";
        psScript += "    } else {\r\n";
        psScript += "        throw \"ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: $response\"\r\n";
        psScript += "    }\r\n";
        psScript += "    \r\n";
        psScript += "    # QUIT\r\n";
        psScript += "    $writer.WriteLine(\"QUIT\")\r\n";
        psScript += "    $response = $reader.ReadLine()\r\n";
        psScript += "    \r\n";
        psScript += "    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\r\n";
        psScript += "    $writer.Close()\r\n";
        psScript += "    $reader.Close()\r\n";
        psScript += "    $stream.Close()\r\n";
        psScript += "    $tcpClient.Close()\r\n";
        psScript += "    \r\n";
        psScript += "    exit 0\r\n";
        psScript += "    \r\n";
        psScript += "} catch {\r\n";
        psScript += "    Write-Error \"ã‚¨ãƒ©ãƒ¼: $_\"\r\n";
        psScript += "    exit 1\r\n";
        psScript += "}\r\n";

        // ä¸€æ™‚PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿å­˜
        var tempPsPath = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_test_mail.ps1");
        var psFile = fso.CreateTextFile(tempPsPath, true);
        psFile.Write(psScript);
        psFile.Close();

        logMessage("PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: " + tempPsPath);

        // PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        var tempOutput = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_test_mail_output.txt");
        var tempError = fso.BuildPath(fso.GetSpecialFolder(2), "rcscheduler_test_mail_error.txt");

        var psCmd = 'powershell.exe -ExecutionPolicy Bypass -NoProfile -File "' + tempPsPath + '"';
        var cmdFull = 'cmd.exe /c ' + psCmd + ' > "' + tempOutput + '" 2> "' + tempError + '"';
        var exitCode = shell.Run(cmdFull, 0, true);

        // å‡ºåŠ›ã‚’èª­ã¿å–ã‚Š
        var output = "";
        var error = "";

        if (fso.FileExists(tempOutput)) {
            var fileObj = fso.GetFile(tempOutput);
            if (fileObj.Size > 0) {
                var outFile = fso.OpenTextFile(tempOutput, 1);
                output = outFile.ReadAll();
                outFile.Close();
            }
            fso.DeleteFile(tempOutput);
        }

        if (fso.FileExists(tempError)) {
            var fileObj = fso.GetFile(tempError);
            if (fileObj.Size > 0) {
                var errFile = fso.OpenTextFile(tempError, 1);
                error = errFile.ReadAll();
                errFile.Close();
            }
            fso.DeleteFile(tempError);
        }

        // ä¸€æ™‚PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤
        if (fso.FileExists(tempPsPath)) {
            fso.DeleteFile(tempPsPath);
        }

        // çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        if (output) {
            var lines = output.split("\n");
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    logMessage("  " + lines[i].trim());
                }
            }
        }

        if (error) {
            var lines = error.split("\n");
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    logMessage("  ERROR: " + lines[i].trim(), "error");
                }
            }
        }

        if (exitCode === 0) {
            logMessage("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ", "success");
            alert("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸã€‚\n\n" +
                  "å®›å…ˆ: " + recipientEmail + "\n" +
                  "ä»¶å: [ãƒ†ã‚¹ãƒˆ] RCScheduler ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ\n\n" +
                  "å—ä¿¡ãƒˆãƒ¬ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } else {
            logMessage("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—", "error");
            alert("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

    } catch(e) {
        logMessage("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n" + e.message);
    }
}

// ======================================
// ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’é–‹ã
// ======================================

function openTaskScheduler() {
    try {
        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...");

        // taskschd.mscã‚’å®Ÿè¡Œã—ã¦ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’é–‹ã
        shell.Run("taskschd.msc", 1, false);

        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’èµ·å‹•ã—ã¾ã—ãŸ", "success");

    } catch(e) {
        logMessage("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
        alert("ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + e.message);
    }
}

</script>

</body>
</html>
